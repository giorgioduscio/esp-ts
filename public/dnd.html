<style>
  /* Usa il blocco :root sottostante come tema unico */
  :root {
    --input: #fdf6e3;
    /* Colori di testo */
    --testo-base: #4a3f35;
    --testo-forte: #3b2f27;
    --testo-etichetta: #6a5a49;
    /* Colori di sfondo */
    --sfondo-chiaro: #f4eade;
    /* Bordi */
    --bordo-base: #c8b89e;
    --bordo-tratteggiato: #d3c0a5;
    /* Colori interattivi */
    --accento-base: #8c7b62;
    /* Colori di stato */
    --verde-chiaro: #d4edda;
    --verde-scuro: #155724;
    --bordo-verde: #c3e6cb;
    --rosso-chiaro: #f8d7da;
    --rosso-scuro: #721c24;
    --bordo-rosso: #f5c6cb;
  }

  


  /* STRUTTURA DOCUMENTO */
  body {
    font-family: 'Times New Roman', Times, serif !important;
    background-color: var(--input);
    color: var(--testo-base);
    margin: 0;
    padding: 1vw;
    font-size: 0.8em;
  }

  article {
    display: flex;
    gap: 5px;
    max-width: 1000px;
    margin: auto;
    padding: 5px;
    background: var(--sfondo-chiaro);
    border: 2px solid var(--bordo-base);
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    border-radius: 5px;
    flex-wrap: wrap;
    justify-content: center;
    align-items: flex-start;
  }

  header {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    gap: 5px;
    border-bottom: 2px solid var(--bordo-base);
    padding-bottom: 15px;
  }
    header>*:last-child {
      flex: 1;
    }
      header>*:last-child input{
        max-width: 80px;
      }

  section {
    flex: 1;
    min-width: 250px;
    width: clamp(250px, 100%, 400px);
    display: flex;
    gap: 10px;
    background: transparent;
    flex-wrap: wrap;
    justify-content: center;
  }
    section>*{
      flex:auto;
    }

  .score, section > details > main {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  /* DETAILS/SUMMARY STYLING */
  section > details {
    width: 100%;
    border: 1px solid var(--bordo-base);
    border-radius: 10px;
    box-shadow: 0 2px 6px #0000000f;
    overflow: hidden;
  }
  section > details:not(:first-child) { margin-top: 8px; }

  section > details > summary {
    list-style: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 10px 12px;
    font-weight: 700;
    color: var(--testo-forte);
    background: linear-gradient(180deg, #fffaf0 0%, #fff5e6 100%);
    border-bottom: 1px solid var(--bordo-base);
    position: relative;
    user-select: none;
  }
  /* Remove default marker */
  section > details > summary::-webkit-details-marker { display: none; }
  section > details > summary::marker { content: ''; }

  /* Custom caret */
  section > details > summary::after {
    content: '';
    width: 8px;
    height: 8px;
    border-right: 2px solid var(--testo-etichetta);
    border-bottom: 2px solid var(--testo-etichetta);
    transform: rotate(-45deg);
    transition: transform 160ms ease;
  }
  section > details[open] > summary::after { transform: rotate(45deg); }

  section > details > summary:hover {
    background: linear-gradient(180deg, #fff8ea 0%, #fff1db 100%);
  }
  section > details > summary:focus-visible {
    outline: 2px solid var(--accento-base);
    outline-offset: 2px;
  }
  section > details > main {
    padding: 10px;
  }
  /* solo per schermi grandi > 805px */
  @media (min-width: 805px) {
    details.privilegi > * {
      max-height: 630px;
      overflow-y: auto;
    }
  }

  /* PICCOLI COMPONENTI */
  form.row{
    display: flex;
    gap: 10px
  }

  .mono > input{
    width: 40px;
  }

  /* COLONNA SINISTRA */
  .mono {
    display: flex;
    flex-direction: row;
    gap: 5px;
    align-items: center;
    justify-content: space-between;
    padding: 5px 10px;
    border: 1px solid var(--bordo-tratteggiato);
    border-radius: 10px;
  }
    .mono>*:last-child{
      max-width: 30px;
      font-weight: bold;
      text-align: center;
    }

  .punteggi {
    padding: 0 10px;
    height: max-content;
    width: 60px;
    display: flex; 
    flex-direction: column; 
    align-items: center;
    border: 1px solid var(--bordo-tratteggiato);
    border-radius: 10px;
  }
    .punteggi>*{
      transform: translateY(10px);
    }
    .punteggi>*:nth-child(1) {
      max-width: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .punteggi>*:nth-child(2) {
      font-size: 1.5em;
      font-weight: bold;
    }
    .punteggi>input {
      width: 40px;
      padding: 5px;
      display: block;
      text-align: center;
      border: 1px solid var(--bordo-tratteggiato) !important;
      border-radius: 10px;
      background: var(--input) !important;
    }

  input, textarea, .input {
    width: clamp(40px, 100%, 300px);
    padding: 5px;
    border: none;
    border-radius: 0;
    color: var(--testo-forte);
    font-family: 'Times New Roman', Times, serif !important;
    box-sizing: border-box;
    text-align: inherit;
    border-bottom: 1px solid var(--bordo-tratteggiato);
  }
  input, textarea {
    background: var(--input);
  }
  textarea {
    resize: none;
    min-height: 60px;
    border: 0;
    border-left: 1px dotted var(--accento-base);
  }
  input:focus, textarea:focus {
    outline: none;
    border-color: var(--accento-base);
  }

  label {
    letter-spacing: 1px;
    color: var(--testo-etichetta);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: inline-block;
    max-width: 100%;
  }
    label::first-letter {
      text-transform: uppercase !important;
    }

    label::first-letter {
      text-transform: uppercase !important;
    }

  h4 {
    font-weight: 700;
    text-align: center;
    border-bottom: 2px solid var(--bordo-base);
    padding-bottom: 5px;
    margin: 10px 0;
    text-transform: uppercase;
  }

  input[type="checkbox"] {
    width: auto;
    accent-color: var(--accento-base);
  }

  button {
    background: var(--accento-base);
    color: var(--input);
    border: 1px solid var(--testo-base);
    border-radius: 3px;
    cursor: pointer;
    padding: 0;
  }
  button:hover {
    background: var(--testo-etichetta);
  }
  /* Limita la larghezza di input/select con classe .add */
  input.add, select.add {
    max-width: 150px;
    width: 100%;
  }

  button.add {
    background-color: var(--verde-chiaro);
    color: var(--verde-scuro);
    border-color: var(--bordo-verde);
  }

  button.delete {
    background-color: var(--rosso-chiaro);
    color: var(--rosso-scuro);
    border-color: var(--bordo-rosso);
  }

  select {
    background: var(--input);
    border: 1px solid var(--bordo-tratteggiato);
    border-radius: 4px;
    padding: 5px;
    color: var(--testo-base);
    width: 100%;
    font-family: 'Times New Roman', Times, serif !important;
  }

  ul {
    list-style-type: none;
    padding-left: 15px;
    margin: 0;
  }

  .list-item {
    display: flex;
    gap: 5px;
    align-items: center;
    margin-bottom: 5px;
  }
  .list-item > input {
    flex-grow: 1;
  }
  .list-item > button {
    flex-shrink: 0;
    width: 25px;
    height: 25px;
    padding: 0;
    line-height: 25px;
  }

  /* Titoli con layout flessibile (testo + pulsanti) */
  .flexTitle {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .list-item {
    display: flex;
    gap: 5px;
    align-items: center;
    margin-bottom: 5px;
  }
  .list-item > input {
    flex-grow: 1;
  }
  .list-item > button {
    flex-shrink: 0;
    width: 25px;
    height: 25px;
    padding: 0;
    line-height: 25px;
  }

  /* Toast "Modificato" */
  .toast {
    position: fixed;
    left: 50%;
    bottom: 16px;
    transform: translateX(-50%);
    background: var(--verde-scuro);
    color: var(--verde-chiaro);
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    font-size: 14px;
    z-index: 9999;
    opacity: 1;
    transition: opacity 300ms ease-out, transform 300ms ease-out;
    pointer-events: none;
  }
  .toast.hide {
    opacity: 0;
    transform: translateX(-50%) translateY(6px);
  }
</style>
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scheda personaggio</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
</head>
<script type="module">

/*
  Autocomplete (modulo minimale e indipendente)

  Obiettivo
  - Fornire un comportamento di autocomplete per input di tipo "search" SENZA caricare dati esterni.
  - Le opzioni sono già presenti nel DOM come <li> dentro un <ul [autocomplete]> abbinato all'input.

  Comportamento
  - Focus (focusin): mostra la lista del campo e applica subito il filtro in base al valore corrente.
    • Se l'input è vuoto: mostra tutte le <li>.
    • Se l'input contiene testo: mostra solo le <li> che includono parzialmente quel testo (case-insensitive).
  - Input (oninput): filtra le <li> della lista associata confrontando il testo digitato con il contenuto delle <li>.
  - Click su <li>: imposta il valore dell'input con il contenuto della <li> selezionata ed emette gli eventi standard
    (input, change, click). La lista si nasconde.
  - Blur (focusout): nasconde la lista con un leggero ritardo per permettere il click sugli elementi.
  - Posizionamento: la lista viene posizionata e dimensionata per allinearsi all'input.

  Requisiti di markup (per ciascun campo con autocomplete)
  - Input:  <input type="search" name="NOME">  (name obbligatorio)
  - Lista:  <ul autocomplete="NOME"> <li>Opzione 1</li> <li>Opzione 2</li> ... </ul>
    • L'ul deve essere nello STESSO contenitore (parent) dell'input.
    • Il contenitore dovrebbe avere position: relative (il modulo lo imposta se è static).
    • Il valore dell'attributo autocomplete dell'ul deve corrispondere esattamente al name dell'input.
    • Non è richiesto alcun attributo id o name sull'ul.

  Cosa NON fa
  - Non ricerca/crea voci dinamicamente e non dipende da moduli esterni.
  - Non usa resolver o sorgenti dati: filtra solo le <li> già presenti nel DOM.

  API
  - Autocomplete.init(): registra una volta i listener globali su document e attiva lo stile.
  - Metodi interni usati dal modulo: updateListGeometry, handleChange, handleFocusin, handleFocusout, handleClick.

  Nota
  - Il modulo è agnostico rispetto all'app: basta rispettare la convenzione input/ul e includere questo file.
*/
export const Autocomplete = {
    // Mappa per riportare l'ul al suo contenitore originale quando viene "portaled" in <body>
    _portal: new WeakMap(),
    // ---------------------------
    // Helpers
    // ---------------------------
    _container(input, ul){
      const container = input?.parentElement;
      if (!container || !container.contains(ul)) return null;
      const cs = getComputedStyle(container);
      if (cs.position === 'static') container.style.position = 'relative';
      return container;
    },
    // Determina se è necessario spostare la lista nel <body> per evitare clipping da overflow
    _shouldPortal(container){
      if (!container) return false;
      if (container === document.body || container === document.documentElement) return false;
      const cs = getComputedStyle(container);
      const ov = `${cs.overflow} ${cs.overflowY} ${cs.overflowX}`;
      return /(auto|scroll|hidden)/.test(ov);
    },
    // Sposta la lista nel body preservando la posizione originale (placeholder)
    _toPortal(input, ul){
      if (Autocomplete._portal.has(ul)) return;
      const parent = ul.parentElement;
      if (!parent) return;
      const placeholder = document.createComment('ac-placeholder');
      parent.insertBefore(placeholder, ul);
      document.body.appendChild(ul);
      Autocomplete._portal.set(ul, { parent, placeholder });
      ul.dataset.portal = '1';
    },
    // Riporta la lista al contenitore originale
    _fromPortal(ul){
      const info = Autocomplete._portal.get(ul);
      if (!info) return;
      try {
        info.parent.insertBefore(ul, info.placeholder);
        info.placeholder.remove();
      } catch {}
      Autocomplete._portal.delete(ul);
      delete ul.dataset.portal;
    },
    // Trova il primo antenato scrollabile; fallback: window
    _scrollParent(el){
      let p = el?.parentElement;
      while (p && p !== document.body) {
        const cs = getComputedStyle(p);
        const canScroll = /(auto|scroll)/.test(cs.overflowY || '') && p.scrollHeight > p.clientHeight;
        if (canScroll) return p;
        p = p.parentElement;
      }
      return window;
    },
    _listFor(input){
      if (!input) return null;
      // 1) prova nel contenitore originale
      const local = input.parentElement?.querySelector(`ul[autocomplete="${CSS.escape(input.name)}"]`);
      if (local) return local;
      // 2) se è stato portato nel body, ricollega tramite data-for = input.id
      const id = input.id;
      if (id) {
        const byId = document.querySelector(`ul[autocomplete="${CSS.escape(input.name)}"][data-for="${CSS.escape(id)}"]`);
        if (byId) return byId;
      }
      // 3) fallback (potenzialmente ambiguo): primo ul che combacia l'attributo
      return document.querySelector(`ul[autocomplete="${CSS.escape(input.name)}"]`);
    },
    _measureContentHeight(ul){
      const prevD = ul.style.display, prevV = ul.style.visibility;
      ul.style.visibility = 'hidden';
      ul.style.display = 'block';
      const maxH = parseInt(getComputedStyle(ul).maxHeight || '180', 10) || 180;
      const h = Math.min(ul.scrollHeight || maxH, maxH);
      ul.style.visibility = prevV || '';
      ul.style.display = prevD || '';
      return { content: h, max: maxH };
    },
    // ARIA: crea/recupera live region per annunci
    _getLive(){
      let el = document.getElementById('autocomplete-live-region');
      if (!el) {
        el = document.createElement('div');
        el.id = 'autocomplete-live-region';
        el.setAttribute('role', 'status');
        el.setAttribute('aria-live', 'polite');
        el.style.position = 'absolute';
        el.style.width = '1px';
        el.style.height = '1px';
        el.style.margin = '-1px';
        el.style.border = '0';
        el.style.padding = '0';
        el.style.clip = 'rect(0 0 0 0)';
        el.style.overflow = 'hidden';
        el.style.whiteSpace = 'nowrap';
        document.body.appendChild(el);
      }
      return el;
    },
    // ARIA: garantisce ruoli/attributi e ID coerenti
    _ensureOptionIds(ul){
      if (!ul.id) ul.id = `ac-${Math.random().toString(36).slice(2, 8)}`;
      const items = Array.from(ul.querySelectorAll('li'));
      items.forEach((li, i) => {
        if (!li.id) li.id = `${ul.id}-opt-${i}`;
        if (li.getAttribute('role') !== 'option') li.setAttribute('role', 'option');
        if (!li.hasAttribute('aria-selected')) li.setAttribute('aria-selected', 'false');
      });
      if (ul.getAttribute('role') !== 'listbox') ul.setAttribute('role', 'listbox');
    },
    _ensureAria(input, ul){
      Autocomplete._ensureOptionIds(ul);
      // collega input <-> lista per recupero anche quando "portaled"
      if (!input.id) input.id = `ac-input-${Math.random().toString(36).slice(2,8)}`;
      ul.dataset.for = input.id;
      input.setAttribute('role', 'combobox');
      input.setAttribute('aria-autocomplete', 'list');
      input.setAttribute('aria-controls', ul.id);
      const expanded = ul.style.display !== 'none';
      input.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      ul.setAttribute('aria-hidden', expanded ? 'false' : 'true');
    },
    // Garantisce che input + lista siano visibili nel viewport o nel contenitore scrollabile
    _ensureVisible(input, ul){
      // Mostra temporaneamente per misurare correttamente
      const prevDisplay = ul.style.display;
      if (prevDisplay === 'none') ul.style.display = 'block';
      // Rettangolo unione tra input e lista
      const rIn = input.getBoundingClientRect();
      const rUl = ul.getBoundingClientRect();
      const unionTop = Math.min(rIn.top, rUl.top);
      const unionBottom = Math.max(rIn.bottom, rUl.bottom);
      const margin = 6;
      const sp = Autocomplete._scrollParent(input);
      if (sp === window) {
        const vh = window.innerHeight;
        if (unionTop < margin) window.scrollBy({ top: unionTop - margin, behavior: 'auto' });
        else if (unionBottom > vh - margin) window.scrollBy({ top: unionBottom - (vh - margin), behavior: 'auto' });
      } else {
        // Calcola delta rispetto al contenitore scrollabile
        const spRect = sp.getBoundingClientRect();
        const topInSp = unionTop - spRect.top; // posizione relativa
        const bottomInSp = unionBottom - spRect.top;
        if (topInSp < margin) sp.scrollTop += topInSp - margin;
        else if (bottomInSp > sp.clientHeight - margin) sp.scrollTop += bottomInSp - (sp.clientHeight - margin);
      }
      // Ripristina display se necessario (non forziamo la visibilità qui)
      ul.style.display = prevDisplay;
    },
    _place(input, ul){
      const container = Autocomplete._container(input, ul);
      if (!container) return;
      const needPortal = Autocomplete._shouldPortal(container);
      if (needPortal) Autocomplete._toPortal(input, ul); else Autocomplete._fromPortal(ul);
      const cr = needPortal ? { top: 0, left: 0 } : container.getBoundingClientRect();
      const ir = input.getBoundingClientRect();
      const left = Math.round(needPortal ? ir.left : (ir.left - cr.left));
      const { content, max } = Autocomplete._measureContentHeight(ul);
      const viewportH = window.innerHeight;
      const spaceBelow = Math.max(0, viewportH - ir.bottom);
      const spaceAbove = Math.max(0, ir.top);
      const gap = 2;
      const below = !(spaceBelow < content + gap && spaceAbove > spaceBelow);
      ul.style.position = needPortal ? 'fixed' : 'absolute';
      ul.style.left = `${left}px`;
      ul.style.width = `${Math.round(ir.width)}px`;
      ul.style.zIndex = '1000';
      ul.dataset.position = below ? 'below' : 'above';
      if (below) {
        const top = needPortal ? Math.round(ir.bottom + gap) : Math.round(ir.bottom - cr.top + gap);
        ul.style.top = `${top}px`;
        ul.style.maxHeight = `${Math.max(60, Math.min(max, spaceBelow - gap))}px`;
      } else {
        const maxAbove = Math.max(60, Math.min(max, spaceAbove - gap));
        ul.style.maxHeight = `${maxAbove}px`;
        const ulH = Math.min(content, maxAbove);
        const top = needPortal ? Math.round(ir.top - gap - ulH) : Math.round(ir.top - cr.top - gap - ulH);
        ul.style.top = `${top}px`;
      }
      // Assicura che input e lista siano immediatamente visibili quando la lista si apre
      Autocomplete._ensureVisible(input, ul);
      // Aggiorna attributi ARIA in base allo stato corrente
      Autocomplete._ensureAria(input, ul);
    },
    // Aggiorna larghezza e posizione della lista in base all'input
    updateListGeometry(input, ul){ if (input && ul) Autocomplete._place(input, ul); },
    // Filtra le opzioni esistenti nella lista in base al valore dell'input
    handleChange(e){
      const el = e.target;
      if (!(el instanceof HTMLInputElement) || el.type !== 'search') return;
      const listEl = Autocomplete._listFor(el);
      if (!listEl) return;
      Autocomplete._ensureAria(el, listEl);
      const term = (el.value || '').toLowerCase().trim();
      // Se il valore corrisponde esattamente a una delle opzioni, non mostrare la lista
      const allItems = Array.from(listEl.querySelectorAll('li'));
      const exactMatch = term !== '' && allItems.some(li => (li.textContent || '').toLowerCase().trim() === term);
      if (exactMatch) {
        // reset visuale e ARIA
        allItems.forEach(li => { li.style.display = 'none'; li.setAttribute('aria-selected', 'false'); });
        listEl.style.display = 'none';
        el.setAttribute('aria-expanded', 'false');
        listEl.setAttribute('aria-hidden', 'true');
        el.removeAttribute('aria-activedescendant');
        // live region: nessun suggerimento quando il valore è già una scelta valida
        try { Autocomplete._getLive().textContent = ''; } catch {}
        return;
      }
      let shown = 0;
      allItems.forEach(li => {
        const match = term === '' || (li.textContent || '').toLowerCase().includes(term);
        li.style.display = match ? '' : 'none';
        if (match) shown++;
        li.setAttribute('aria-selected', 'false');
      });
      Autocomplete.updateListGeometry(el, listEl);
      listEl.style.display = shown ? 'block' : 'none';
      // ARIA: stato espanso/nascosto + annuncio risultati
      el.setAttribute('aria-expanded', shown ? 'true' : 'false');
      listEl.setAttribute('aria-hidden', shown ? 'false' : 'true');
      const live = Autocomplete._getLive();
      live.textContent = shown ? `${shown} opzioni disponibili` : 'Nessuna opzione disponibile';
      // reset active descendant
      if (!shown) el.removeAttribute('aria-activedescendant');
    },
    // Mostra la lista al focus e applica subito il filtro corrente
    handleFocusin(e){
      const el = e.target;
      if (el instanceof HTMLInputElement && el.type === 'search') {
        const listEl = Autocomplete._listFor(el);
        if (listEl) Autocomplete._ensureAria(el, listEl);
        Autocomplete.handleChange({ target: el });
      }
    },
    // Nasconde la lista poco dopo la perdita di focus (per permettere il click sui <li>)
    handleFocusout(e){
      const el = e.target;
      setTimeout(() => {
        const active = document.activeElement;
        const listEl = el instanceof HTMLInputElement ? Autocomplete._listFor(el) : null;
        const stillInside = active && (active === el || (listEl && listEl.contains(active)));
        if (!stillInside && listEl) {
          listEl.style.display = 'none';
          // se era in portal, riportalo al contenitore originale
          Autocomplete._fromPortal(listEl);
          if (el instanceof HTMLInputElement) {
            el.setAttribute('aria-expanded', 'false');
            el.removeAttribute('aria-activedescendant');
          }
          listEl.setAttribute('aria-hidden', 'true');
        }
      }, 120);
    },
    handleClick(e){
      // Previeni il blur dell'input prima della selezione
      e.preventDefault?.();
      e.stopPropagation?.();
      const li = e.target;
      if (!(li && li.tagName === 'LI')) return;
      const ul = li.closest('ul[autocomplete]');
      if (!ul) return;
      const name = ul.getAttribute('autocomplete');
      const input = ul.parentElement?.querySelector(`input[name="${CSS.escape(name)}"]`);
      if (!input) return;
      // Imposta valore completo
      input.value = li.textContent || '';
      // Mantiene focus e caret alla fine
      input.focus();
      try { const len = input.value.length; input.setSelectionRange?.(len, len); } catch {}
      // Notifica gli eventi standard
      input.dispatchEvent(new InputEvent('input', { bubbles: true }));
      input.dispatchEvent(new Event('change', { bubbles: true }));
      input.dispatchEvent(new Event('click', { bubbles: true }));
      // ARIA: selezione e stato
      try {
        // marca l'opzione selezionata
        Array.from(ul.querySelectorAll('li')).forEach(n => n.setAttribute('aria-selected', n === li ? 'true' : 'false'));
        Autocomplete._ensureAria(input, ul);
        if (li.id) input.setAttribute('aria-activedescendant', li.id);
      } catch {}
      // Nasconde la lista
      ul.style.display = 'none';
      input.setAttribute('aria-expanded', 'false');
      input.removeAttribute('aria-activedescendant');
      ul.setAttribute('aria-hidden', 'true');
      // se era in portal, riportalo al contenitore originale
      Autocomplete._fromPortal(ul);
      // Annuncio
      try { Autocomplete._getLive().textContent = `Selezionato: ${li.textContent?.trim() || ''}`; } catch {}
    },
    // Evidenzia l'elemento attivo e lo rende visibile nella lista (pattern aria-activedescendant)
    setActive(listEl, items, index){
      items.forEach((li, i) => li.classList.toggle('active', i === index));
      listEl.dataset.activeIndex = String(index);
      // ARIA: selezione logica sull'opzione attiva
      items.forEach((li, i) => li.setAttribute('aria-selected', i === index ? 'true' : 'false'));
      const input = listEl.previousElementSibling instanceof HTMLInputElement ? listEl.previousElementSibling : listEl.parentElement?.querySelector('input[type="search"]');
      if (input) {
        Autocomplete._ensureAria(input, listEl);
        const active = items[index];
        if (active) input.setAttribute('aria-activedescendant', active.id || '');
      }
      const active = items[index];
      if (active) active.scrollIntoView({ block: 'nearest' });
    },
    // Restituisce le <li> visibili (non display:none)
    visibleItems(listEl){
      return Array.from(listEl.querySelectorAll('li')).filter(li => li.style.display !== 'none');
    },
    getStyle(){
      // crea un elemento nel dom <style> e lo appende al <head>
      const style = document.createElement('style');
      style.textContent =`
        /* Autocomplete dropdown */
        ul[autocomplete] {
          position: absolute;
          z-index: 1000;
          list-style: none;
          margin: 0; /* gestiamo il gap via JS */
          padding: 0;
          background: var(--input);
          border: 1px solid var(--bordo-tratteggiato);
          border-radius: 4px;
          width: 100%;
          left: 0;
          max-height: 180px;
          overflow: auto;
          display: none;
          text-transform: none; /* override h4 uppercase */
        }
        /* Opzionale: cambia raggio per posizione sopra/sotto */
        ul[autocomplete][data-position="above"] { border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; }
        ul[autocomplete][data-position="below"] { border-top-left-radius: 4px; border-top-right-radius: 4px; }
        ul[autocomplete] > li {
          padding: 4px 8px;
          cursor: pointer;
          text-transform: none; /* ensure item text case preserved */
        }
        ul[autocomplete] > li:hover {
          background: var(--sfondo-chiaro);
        }
        ul[autocomplete] > li.active {
          background: var(--bordo-tratteggiato);
          outline: 1px solid var(--bordo-base);
        }
      `;
      document.head.appendChild(style);
    },
    _bound: false, // per evitare di bindare più volte
    init(){
      if (Autocomplete._bound) return;
      Autocomplete._bound = true;
      Autocomplete.getStyle()
      // Delegated input -> filtro
      document.addEventListener('input', (e) => Autocomplete.handleChange(e));
      // Delegated focusin -> mostra e filtra
      document.addEventListener('focusin', (e) => Autocomplete.handleFocusin(e));
      // Delegated focusout -> nascondi
      document.addEventListener('focusout', (e) => Autocomplete.handleFocusout(e));
      // Delegated mousedown on suggestions (prima del blur)
      document.addEventListener('mousedown', (e) => {
        const li = e.target;
        if (li instanceof HTMLElement && li.closest('ul[autocomplete]')) Autocomplete.handleClick(e);
      });
      // Keydown su input[type=search] per navigazione
      document.addEventListener('keydown', (e) => {
        const el = e.target;
        if (!(el instanceof HTMLInputElement) || el.type !== 'search') return;
        const listEl = Autocomplete._listFor(el);
        if (!listEl) return;
        const isOpen = listEl.style.display !== 'none';
        const items = Autocomplete.visibleItems(listEl);
        const n = items.length;
        if (!n) return;
        const current = parseInt(listEl.dataset.activeIndex || '-1', 10);
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault();
          const next = e.key === 'ArrowDown' ? (current + 1) % n : (current <= 0 ? n - 1 : current - 1);
          Autocomplete.setActive(listEl, items, next);
          if (!isOpen) listEl.style.display = 'block';
        } else if (e.key === 'Enter') {
          const idx = parseInt(listEl.dataset.activeIndex || '-1', 10);
          if (idx >= 0 && isOpen) {
            e.preventDefault();
            const li = items[idx];
            if (li) Autocomplete.handleClick({ preventDefault(){}, stopPropagation(){}, target: li });
          }
        } else if (e.key === 'Escape') {
          listEl.style.display = 'none';
          el.setAttribute('aria-expanded', 'false');
          el.removeAttribute('aria-activedescendant');
          listEl.setAttribute('aria-hidden', 'true');
        }
      });
      // Riposiziona su scroll/resize in cattura
      const reflowActive = () => {
        const active = document.activeElement;
        if (active instanceof HTMLInputElement && active.type === 'search') {
          const listEl = Autocomplete._listFor(active);
          if (listEl) Autocomplete.updateListGeometry(active, listEl);
        }
      };
      window.addEventListener('scroll', reflowActive, true);
      window.addEventListener('resize', reflowActive, true);
    }
  }


/**
 * Elemento dei privilegi base (lista classi principali)
 * @typedef {Object} BasePrivilegioItem
 * @property {string} class
 * @property {number} level
 * @property {string} privilege
 * @property {string} [description]
 */

/**
 * Elemento dei privilegi per sottoclassi
 * @typedef {Object} PrivilegioItem
 * @property {number} level
 * @property {string} privilege
 * @property {string} [description]
 */

/**
 * Mappa delle sottoclassi: { [classe]: { [sottoclasse]: PrivilegioItem[] } }
 * @typedef {Object.<string, Object.<string, PrivilegioItem[]>>} SottoclassiMap
 */

 export const DND = {
  /** @type {BasePrivilegioItem[]} */
  classi: [
    {
      class: 'barbaro',
      level: 1,
      privilege: 'Difesa senza armatura',
      description: 'Se non indossi armatura pesante, CA = 10 + mod DES + mod COS, anche con scudo.'
    },
    {
      class: 'barbaro',
      level: 1,
      privilege: 'Ira',
      description: 'Puoi entrare in ira fino a 2 volte per riposo lungo.\n- Dura 1 minuto, termina se cadi privo di sensi o se non attacchi/subisci danni in un turno.\n- Vantaggio su prove di Forza e tiri salvezza su Forza.\n- Bonus ai danni da mischia con armi basate su Forza.\n- Resistenza a danni contundenti, perforanti e taglienti.'
    },
    {
      class: 'barbaro',
      level: 2,
      privilege: 'Attacco temerario',
      description: 'Puoi ottenere vantaggio sul primo attacco del turno, ma gli attacchi contro di te hanno vantaggio fino al prossimo turno.'
    },
    {
      class: 'barbaro',
      level: 2,
      privilege: 'Privilegio del Cammino primordiale',
      description: 'Scegli un cammino primordiale che conferisce abilità uniche.'
    },
    {
      class: 'barbaro',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'barbaro',
      level: 5,
      privilege: 'Attacco extra',
      description: 'Puoi effettuare due attacchi invece di uno quando usi l’azione Attacco.'
    },
    {
      class: 'barbaro',
      level: 5,
      privilege: 'Movimento veloce',
      description: 'Se non indossi armatura pesante, aumenti la velocità di 3 metri.'
    },
    {
      class: 'barbaro',
      level: 6,
      privilege: 'Privilegio del Cammino primordiale',
      description: 'Miglioramenti aggiuntivi alle abilità del cammino primordiale scelto.'
    },
    {
      class: 'barbaro',
      level: 7,
      privilege: 'Istinto ferino',
      description: 'Agisci normalmente se sorpreso solo se entri in ira all’inizio del combattimento.'
    },
    {
      class: 'barbaro',
      level: 8,
      privilege: 'Incremento punteggi caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'barbaro',
      level: 9,
      privilege: 'Critico brutale',
      description: 'Aggiungi 1 dado al danno di un colpo critico.'
    },
    {
      class: 'barbaro',
      level: 10,
      privilege: 'Privilegio del Cammino primordiale',
      description: 'Ulteriori miglioramenti alle abilità del cammino primordiale.'
    },
    {
      class: 'barbaro',
      level: 11,
      privilege: 'Ira implacabile',
      description: 'Se cadi a 0 HP in ira, puoi fare un tiro salvezza CD 10 su Costituzione per restare a 1 HP.'
    },
    {
      class: 'barbaro',
      level: 12,
      privilege: 'Incremento punteggi caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'barbaro',
      level: 13,
      privilege: 'Critico brutale',
      description: 'Aggiungi 2 dadi al danno di un colpo critico.'
    },
    {
      class: 'barbaro',
      level: 14,
      privilege: 'Privilegio del Cammino primordiale',
      description: 'Ancora miglioramenti alle abilità del cammino primordiale.'
    },
    {
      class: 'barbaro',
      level: 15,
      privilege: 'Inarrestabile',
      description: 'Come reazione, puoi ignorare una condizione di incapacità fino alla fine del turno.'
    },
    {
      class: 'barbaro',
      level: 16,
      privilege: 'Incremento punteggi caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'barbaro',
      level: 17,
      privilege: 'Critico brutale',
      description: 'Aggiungi 3 dadi al danno di un colpo critico.'
    },
    {
      class: 'barbaro',
      level: 18,
      privilege: 'Potere indomabile',
      description: 'Puoi ritirare un tiro salvezza fallito una volta per riposo lungo.'
    },
    {
      class: 'barbaro',
      level: 19,
      privilege: 'Incremento punteggi caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'barbaro',
      level: 20,
      privilege: 'Campione primordiale',
      description: 'Forza e Costituzione aumentano di 4 (max 24).'
    },
    {
      class: 'ladro',
      level: 1,
      privilege: "Attacco Furtivo",
      description: "Una volta per turno, puoi infliggere danni extra a una creatura che colpisci con un attacco con arma con arma accurata. Puoi avvinare quando, dadi di vantaggio sul tiro per colpire a quando il bersaglio ha un avversario a 1,5m."
    },
    {
      class: 'ladro',
      level: 1,
      privilege: "Gergo Ladresco",
      description: "Impari gergo e codici che criptano messaggi. Sali un altro ladro più comprendi. Ci vuole il quadrupolo del tempo per trasmetterli. Inoltre, comprendi una serie di segni e simboli segreti per messaggi semplici e brevi (area pericolosa, territorio della gilda dei ladri, bottino nelle vicinanze, abitanti facili prede o possono fermarti in luogo ad un ladro in fuga)."
    },
    {
      class: 'ladro',
      level: 2,
      privilege: "Maestria",
      description: "Puoi scegliere due abilità o un'abilità e un attacco da scasso) in cui ha competenza. Il Bonus Competenza per quelle prove è raddoppiato."
    },
    {
      class: 'ladro',
      level: 2,
      privilege: "Ladro",
      description: "Puoi scattare guadagnati azione bonus una volta a turno per Disimpegno, Nascondersi o Scattare."
    },
    {
      class: 'ladro',
      level: 3,
      privilege: "Privilegio dell'archetipo - Mira Stabile (Tasha)",
      description: "Se non ti muovi nel tuo turno, puoi spendere l'azione bonus per darti vantaggio sul tuo prossimo tiro per colpire di tiro con arma."
    },
    {
      class: 'ladro',
      level: 4,
      privilege: "Incremento punteggi di caratteristica",
      description: "Aumenta di 2 un punteggio di caratteristica."
    },
    {
      class: 'ladro',
      level: 5,
      privilege: "Schivata Prodigiosa",
      description: "Quando un attaccante che sei in grado di vedere ti colpisce con un attacco, puoi usare la tua reazione per dimezzare il danno dell'attacco effettuato contro di te."
    },
    {
      class: 'ladro',
      level: 6,
      privilege: "Maestria 2",
      description: "Puoi scegliere altre due competenze."
    },
    {
      class: 'ladro',
      level: 7,
      privilege: "Illusione",
      description: "Quando sei vittima di un effetto che ti permette di compiere un tiro salvezza su Destrezza per dimezzare i danni, non subisci danni se superi il tiro salvezza, e solo metà danni se lo fallisci."
    },
    {
      class: 'ladro',
      level: 8,
      privilege: "Incremento punteggi di caratteristica",
      description: "Aumenta di 2 un punteggio di caratteristica."
    },
    {
      class: 'ladro',
      level: 9,
      privilege: "Privilegio dell'archetipo",
      description: "Privilegio speciale dell'archetipo a questo livello."
    },
    {
      class: 'ladro',
      level: 10,
      privilege: "Incremento punteggi di caratteristica",
      description: "Aumenta di 2 un punteggio di caratteristica."
    },
    {
      class: 'ladro',
      level: 11,
      privilege: 'Talento Affidabile',
      description: 'Quando tiri un d20 per una prova con competenza, tratti i risultati inferiori a 10 come 10.'
    },
    {
      class: 'ladro',
      level: 12,
      privilege: 'Incremento punteggi di caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica.'
    },
    {
      class: 'ladro',
      level: 13,
      privilege: "Privilegio dell'archetipo",
      description: 'Privilegio speciale dell’archetipo a questo livello.'
    },
    {
      class: 'ladro',
      level: 14,
      privilege: 'Senso Cieco',
      description: 'Percepisci le creature invisibili entro 3 metri se non sono completamente coperte.'
    },
    {
      class: 'ladro',
      level: 15,
      privilege: 'Mente Sfuggente',
      description: 'Ottieni competenza nei tiri salvezza su Saggezza.'
    },
    {
      class: 'ladro',
      level: 16,
      privilege: 'Incremento punteggi di caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica.'
    },
    {
      class: 'ladro',
      level: 17,
      privilege: "Privilegio dell'archetipo",
      description: 'Privilegio speciale dell’archetipo a questo livello.'
    },
    {
      class: 'ladro',
      level: 18,
      privilege: 'Inafferrabile',
      description: 'Finché non sei incapacitato, gli attacchi contro di te non hanno mai vantaggio.'
    },
    {
      class: 'ladro',
      level: 19,
      privilege: 'Incremento punteggi di caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica.'
    },
    {
      class: 'ladro',
      level: 20,
      privilege: 'Colpo di Fortuna',
      description: 'Una volta per riposo breve, puoi trasformare un tiro mancato in un colpo riuscito o far riuscire una prova.'
    },
    {
      class: 'ranger',
      level: 1,
      privilege: 'Imparare 2 lingue e duplicare la competenza',
      description: 'Impari 2 lingue e duplichi la tua competenza in un’abilità in cui sei competente.'
    },
    {
      class: 'ranger',
      level: 2,
      privilege: 'Stile di Combattimento',
      description: 'Scegli uno stile di combattimento tra quelli disponibili per migliorare le tue capacità in battaglia.'
    },
    {
      class: 'ranger',
      level: 3,
      privilege: 'Archetipo Ranger',
      description: 'Scegli un archetipo che definisce il tuo stile e le tue abilità uniche.'
    },
    {
      class: 'ranger',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi di 1.'
    },
    {
      class: 'ranger',
      level: 5,
      privilege: 'Attacco Extra',
      description: 'Puoi effettuare due attacchi invece di uno quando usi l’azione Attacco.'
    },
    {
      class: 'ranger',
      level: 6,
      privilege: 'Consapevolezza Primordiale',
      description: 'Puoi spendere uno slot incantesimo e per 1 minuto +incantesimo, puoi percepire le creature entro 1,5 km (10 km in territorio affine).'
    },
    {
      class: 'ranger',
      level: 7,
      privilege: 'Incremento Caratteristica',
      description: 'Un punteggio di caratteristica di 2 o due punteggi di 1.'
    },
    {
      class: 'ranger',
      level: 8,
      privilege: 'Attacco Extra',
      description: 'Puoi effettuare due attacchi invece di uno quando usi l’azione Attacco.'
    },
    {
      class: 'ranger',
      level: 9,
      privilege: 'Vagabondo',
      description: 'La velocità aumenta di 1,5m e il movimento di nuoto e scalata hanno la stessa velocità di camminata. Danni aumentati di 6 se avversario prescelto.'
    },
    {
      class: 'ranger',
      level: 10,
      privilege: 'Andatura sul Territorio',
      description: 'Puoi attraversare territori e vegetali senza essere rallentato o senza subire danni da essi, e puoi percepire i pericoli naturali.'
    },
    {
      class: 'ranger',
      level: 11,
      privilege: 'Incremento Caratteristica',
      description: 'Un punteggio di caratteristica di 2 o due punteggi di 1.'
    },
    {
      class: 'ranger',
      level: 12,
      privilege: 'Implacabile',
      description: 'Come reazione, puoi ignorare condizioni di incapacità fino alla fine del turno.'
    },
    {
      class: 'ranger',
      level: 13,
      privilege: 'Incremento Caratteristica',
      description: 'Un punteggio di caratteristica di 2 o due punteggi di 1.'
    },
    {
      class: 'ranger',
      level: 14,
      privilege: 'Avversario prescelto',
      description: 'I danni aumentano di 8 contro il tuo avversario prescelto.'
    },
    {
      class: 'ranger',
      level: 15,
      privilege: 'Incremento Caratteristica',
      description: 'Un punteggio di caratteristica di 2 o due punteggi di 1.'
    },
    {
      class: 'ranger',
      level: 16,
      privilege: 'Incremento Caratteristica',
      description: 'Un punteggio di caratteristica di 2 o due punteggi di 1.'
    },
    {
      class: 'ranger',
      level: 17,
      privilege: 'Incremento Caratteristica',
      description: 'Un punteggio di caratteristica di 2 o due punteggi di 1.'
    },
    {
      class: 'ranger',
      level: 18,
      privilege: 'Sensi Ferini',
      description: 'Quando attacchi una creatura che non puoi vedere, hai vantaggio ai tiri per colpire.'
    },
    {
      class: 'ranger',
      level: 19,
      privilege: 'Incremento Caratteristica',
      description: 'Un punteggio di caratteristica di 2 o due punteggi di 1.'
    },
    {
      class: 'ranger',
      level: 20,
      privilege: 'Sterminatore di Nemici',
      description: 'Puoi sommare un dado danno extra al tuo attacco per turno. Usa questo privilegio prima o dopo il tiro.'
    },
    {
      class: 'guerriero',
      level: 1,
      privilege: 'Recupero energia',
      description: 'Dopo un riposo, puoi spendere un\'azione bonus e recuperare punti ferita pari a d10 + livello guerriero.'
    },
    {
      class: 'guerriero',
      level: 1,
      privilege: 'Stile combattimento',
      description: 'Armi possenti, 2 armi, Difesa, Duellare, Protezione, Tiri.'
    },
    {
      class: 'guerriero',
      level: 2,
      privilege: 'Azione impetuosa',
      description: 'Dopo un riposo, ottieni un\'azione aggiuntiva e una possibile azione bonus nel proprio turno.'
    },
    {
      class: 'guerriero',
      level: 3,
      privilege: 'Privilegio archetipo',
      description: 'Scegli un archetipo di guerriero che conferisce abilità speciali.'
    },
    {
      class: 'guerriero',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta un punteggio di caratteristica di 2, o due punteggi di 1.'
    },
    {
      class: 'guerriero',
      level: 5,
      privilege: 'Attacco extra +1',
      description: 'Effettui due attacchi invece di uno quando usi l\'azione Attacco.'
    },
    {
      class: 'guerriero',
      level: 7,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta un punteggio di caratteristica di 2, o due punteggi di 1.'
    },
    {
      class: 'guerriero',
      level: 8,
      privilege: 'Privilegio archetipo',
      description: ''
    },
    {
      class: 'guerriero',
      level: 9,
      privilege: 'Indomito',
      description: 'Dopo un riposo, puoi ritirare un tiro salvezza che fallisce.'
    },
    {
      class: 'guerriero',
      level: 10,
      privilege: 'Privilegio archetipo',
      description: ''
    },
    {
      class: 'guerriero',
      level: 11,
      privilege: 'Attacco extra +2',
      description: 'Effettui tre attacchi invece di uno quando usi l\'azione Attacco.'
    },
    {
      class: 'guerriero',
      level: 12,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta un punteggio di caratteristica di 2, o due punteggi di 1.'
    },
    {
      class: 'guerriero',
      level: 13,
      privilege: 'Indomito',
      description: 'Puoi ritirare due tiri salvezza che fallisci tra i riposi.'
    },
    {
      class: 'guerriero',
      level: 14,
      privilege: 'Privilegio archetipo',
      description: ''
    },
    {
      class: 'guerriero',
      level: 15,
      privilege: 'Attacco extra +3',
      description: 'Effettui quattro attacchi invece di uno quando usi l\'azione Attacco.'
    },
    {
      class: 'guerriero',
      level: 16,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta un punteggio di caratteristica di 2, o due punteggi di 1.'
    },
    {
      class: 'guerriero',
      level: 17,
      privilege: 'Indomito',
      description: 'Puoi ritirare tre tiri salvezza che fallisci tra i riposi.'
    },
    {
      class: 'guerriero',
      level: 18,
      privilege: 'Privilegio archetipo',
      description: ''
    },
    {
      class: 'guerriero',
      level: 19,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta un punteggio di caratteristica di 2, o due punteggi di 1.'
    },
    {
      class: 'guerriero',
      level: 20,
      privilege: 'Attacco extra +4',
      description: 'Effettui cinque attacchi invece di uno quando usi l\'azione Attacco.'
    },
    {
      class: 'monaco',
      level: 1,
      privilege: 'Difesa senza armatura',
      description: 'Se non indossi armatura pesante, CA = 10 + mod Destrezza + mod Saggezza.'
    },
    {
      class: 'monaco',
      level: 1,
      privilege: 'Uso delle armi senza armatura',
      description: 'Le armi da monaco usano il modificatore di Destrezza per attacchi e danni.'
    },
    {
      class: 'monaco',
      level: 1,
      privilege: 'Aumento colpo senz\'armi',
      description: 'Danni del colpo senz\'armi diventano d6.'
    },
    {
      class: 'monaco',
      level: 2,
      privilege: 'Movimento senza armatura',
      description: 'La velocità aumenta di 9 metri se non indossi armatura o scudo.'
    },
    {
      class: 'monaco',
      level: 3,
      privilege: 'Privilegio della tradizione monastica',
      description: 'Scegli una tradizione monastica che conferisce abilità uniche.'
    },
    {
      class: 'monaco',
      level: 4,
      privilege: 'Aumento punteggi di caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi di 1.'
    },
    {
      class: 'monaco',
      level: 5,
      privilege: 'Movimento senza armatura',
      description: 'La velocità aumenta di ulteriori 9 metri se non indossi armatura o scudo.'
    },
    {
      class: 'monaco',
      level: 5,
      privilege: 'Aumento colpo senz\'armi',
      description: 'Danni del colpo senz\'armi diventano d8.'
    },
    {
      class: 'monaco',
      level: 6,
      privilege: 'Corpo vuoto',
      description: 'Resistenza a malattie e veleni.'
    },
    {
      class: 'monaco',
      level: 7,
      privilege: 'Movimento senza armatura',
      description: 'La velocità aumenta di ulteriori 9 metri se non indossi armatura o scudo.'
    },
    {
      class: 'monaco',
      level: 8,
      privilege: 'Aumento punteggi di caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi di 1.'
    },
    {
      class: 'monaco',
      level: 9,
      privilege: 'Movimento senza armatura',
      description: 'La velocità aumenta di ulteriori 9 metri se non indossi armatura o scudo.'
    },
    {
      class: 'monaco',
      level: 9,
      privilege: 'Aumento colpo senz\'armi',
      description: 'Danni del colpo senz\'armi diventano d10.'
    },
    {
      class: 'monaco',
      level: 10,
      privilege: 'Perfezione interiore',
      description: 'Se rimani senza Ki, non ne recuperi 4.'
    },
    {
      class: 'monaco',
      level: 11,
      privilege: 'Aumento colpo senz\'armi',
      description: 'Danni del colpo senz\'armi diventano d12.'
    },    
    {
      class: 'monaco',
      level: 12,
      privilege: 'Aumento punteggi di caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi di 1.'
    },
    {
      class: 'monaco',
      level: 13,
      privilege: 'Linguaggio del Sole e della Luna',
      description: 'Comprendi e ti fai comprendere da qualsiasi creatura che conosca almeno una lingua.'
    },
    {
      class: 'monaco',
      level: 14,
      privilege: 'Anima di Diamante',
      description: 'Competenza in tutti i tiri salvezza; puoi spendere 1 Ki per ritirare un TS fallito.'
    },
    {
      class: 'monaco',
      level: 15,
      privilege: 'Corpo senza Tempo',
      description: 'Non soffri gli effetti dell’età in combattimento e non puoi essere invecchiato magicamente.'
    },
    {
      class: 'monaco',
      level: 16,
      privilege: 'Aumento punteggi di caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi di 1.'
    },
    {
      class: 'monaco',
      level: 17,
      privilege: 'Privilegio della tradizione monastica',
      description: 'La tua tradizione conferisce un privilegio aggiuntivo a questo livello.'
    },
    {
      class: 'monaco',
      level: 18,
      privilege: 'Corpo Vuoto',
      description: 'Puoi diventare invisibile e ottenere resistenza ai danni con un uso del Ki; puoi anche proiettare la tua presenza.'
    },
    {
      class: 'monaco',
      level: 19,
      privilege: 'Aumento punteggi di caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi di 1.'
    },
    {
      class: 'monaco',
      level: 20,
      privilege: 'Sé Perfetto',
      description: 'Quando tiri iniziativa e non hai punti Ki, ne recuperi automaticamente.'
    },
    {
      class: 'paladino',
      level: 1,
      privilege: 'Imposizione delle Mani',
      description: "Dopo riposo lungo, ripristini Punti ferita - liv * 5, puoi spendere 5 punti ferita per curare da malattie e veleni, non ha effetto su contratti e non morti."
    },
    {
      class: 'paladino',
      level: 1,
      privilege: 'Percezione del Divino',
      description: "Il paladino percepisce la presenza e il tipo di ogni creatura entro 18m da lui e che non si trovi sotto copertura totale. Utilizzi 1° mod CAR e dal riposo lungo recupera tutti gli utilizzi."
    },
    {
      class: 'paladino',
      level: 2,
      privilege: 'Stile di Combattimento',
      description: "Puoi combattere con un'arma da mischia, puoi spendere uno slot incantesimo per infliggere danni radiosi."
    },
    {
      class: 'paladino',
      level: 3,
      privilege: 'Salute Divina',
      description: "Il paladino diventa immune alle malattie."
    },
    {
      class: 'paladino',
      level: 4,
      privilege: 'Aumento di Punteggi Caratteristica',
      description: "Aumenta di 2 o due di 1."
    },
    {
      class: 'paladino',
      level: 5,
      privilege: 'Attacco Extra',
      description: "Puoi attaccare una seconda volta entro 3m durante un turno."
    },
    {
      class: 'paladino',
      level: 7,
      privilege: 'Aura di Protezione',
      description: "Se il paladino o un alleato entro 3m devono fare un tiro salvezza, ottengono un bonus pari a mod CAR."
    },
    {
      class: 'paladino',
      level: 8,
      privilege: 'Privilegio del giuramento',
      description: "Privilegio speciale conferito dall'archetipo scelto."
    },
    {
      class: 'paladino',
      level: 9,
      privilege: 'Aumento di Punteggi Caratteristica',
      description: "Aumenta di 2 o due di 1."
    },
    {
      class: 'paladino',
      level: 10,
      privilege: 'Aura di Coraggio',
      description: "Paladino e creature amiche entro 3m non possono essere spaventate finché il paladino è cosciente."
    },
    {
      class: 'paladino',
      level: 11,
      privilege: 'Punizione Divina Migliorata',
      description: "Danni radiosi migliorati."
    },
    {
      class: 'paladino',
      level: 12,
      privilege: 'Aumento di Punteggi Caratteristica',
      description: "Aumenta di 2 o due di 1."
    },
    {
      class: 'paladino',
      level: 13,
      privilege: 'Privilegio del giuramento',
      description: "Privilegio speciale conferito dall'archetipo scelto."
    },
    {
      class: 'paladino',
      level: 14,
      privilege: 'Incorruzione Punitrice',
      description: "Con un tocco, puoi cessare un incantesimo su te stesso e i consenzienti. Numero utilizzi = mod CAR, si ricarica dopo riposo."
    },
    {
      class: 'paladino',
      level: 15,
      privilege: 'Privilegio del giuramento',
      description: "Privilegio speciale conferito dall'archetipo scelto."
    },
    {
      class: 'paladino',
      level: 16,
      privilege: 'Aumento di Punteggi Caratteristica',
      description: "Aumenta di 2 o due di 1."
    },
    {
      class: 'paladino',
      level: 17,
      privilege: 'Privilegio del giuramento',
      description: "Privilegio speciale conferito dall'archetipo scelto."
    },
    {
      class: 'paladino',
      level: 18,
      privilege: 'Aura Migliorata',
      description: "Aura migliorata con raggio di 9m."
    },
    {
      class: 'paladino',
      level: 19,
      privilege: 'Aumento di Punteggi Caratteristica',
      description: "Aumenta di 2 o due di 1."
    },
    {
      class: 'paladino',
      level: 20,
      privilege: 'Campione Divino',
      description: "Privilegio speciale di alto livello, migliora poteri divini."
    },

    // --- Bardo ---
    {
      class: 'bardo',
      level: 1,
      privilege: 'Ispirazione Bardica',
      description: 'Come azione bonus, conferisci un dado ispirazione a un alleato; usi per riposo.'
    },
    {
      class: 'bardo',
      level: 2,
      privilege: 'Canto del Riposo',
      description: 'Durante un riposo breve, gli alleati che ascoltano recuperano PF extra.'
    },
    {
      class: 'bardo',
      level: 2,
      privilege: 'Maestria Parziale',
      description: 'Aggiungi un bonus a tiri di abilità non competenti (Jack of All Trades).'
    },
    {
      class: 'bardo',
      level: 3,
      privilege: 'Collegio Bardico',
      description: 'Scegli un collegio che conferisce privilegi unici.'
    },
    {
      class: 'bardo',
      level: 3,
      privilege: 'Maestria (Expertise)',
      description: 'Scegli due abilità in cui raddoppi il bonus di competenza.'
    },
    {
      class: 'bardo',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'bardo',
      level: 5,
      privilege: 'Fonti di Ispirazione',
      description: 'Recuperi usi di Ispirazione Bardica con un riposo breve.'
    },
    {
      class: 'bardo',
      level: 5,
      privilege: 'Ispirazione Bardica (dado migliorato)',
      description: 'Il dado di Ispirazione Bardica aumenta di taglia.'
    },
    {
      class: 'bardo',
      level: 6,
      privilege: 'Controincanto',
      description: 'Come azione, esegui una performance che conferisce vantaggio ai TS su charme/paura agli alleati vicini.'
    },
    {
      class: 'bardo',
      level: 7,
      privilege: 'Magia Avanzata',
      description: 'Accedi a incantesimi di livello superiore e perfezioni le tue arti magiche.'
    },
    {
      class: 'bardo',
      level: 8,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'bardo',
      level: 9,
      privilege: 'Canto del Riposo (migliorato)',
      description: 'Il bonus di Canto del Riposo aumenta.'
    },
    {
      class: 'bardo',
      level: 10,
      privilege: 'Segreti Magici',
      description: 'Impari 2 incantesimi da qualunque lista; diventano incantesimi da bardo per te.'
    },
    {
      class: 'bardo',
      level: 10,
      privilege: 'Maestria (ulteriore)',
      description: 'Scegli altre due abilità per raddoppiare il bonus di competenza.'
    },
    {
      class: 'bardo',
      level: 10,
      privilege: 'Ispirazione Bardica (dado migliorato)',
      description: 'Il dado di Ispirazione Bardica aumenta nuovamente di taglia.'
    },
    {
      class: 'bardo',
      level: 11,
      privilege: 'Incantesimi Superiori',
      description: 'Accedi a incantesimi di livello più alto.'
    },
    {
      class: 'bardo',
      level: 12,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'bardo',
      level: 13,
      privilege: 'Canto del Riposo (migliorato)',
      description: 'Il bonus di Canto del Riposo aumenta.'
    },
    {
      class: 'bardo',
      level: 14,
      privilege: 'Segreti Magici Superiori',
      description: 'Impari 2 ulteriori incantesimi da qualunque lista; diventano incantesimi da bardo.'
    },
    {
      class: 'bardo',
      level: 15,
      privilege: 'Ispirazione Bardica (dado migliorato)',
      description: 'Il dado di Ispirazione Bardica raggiunge la sua taglia massima.'
    },
    {
      class: 'bardo',
      level: 16,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'bardo',
      level: 17,
      privilege: 'Canto del Riposo (migliorato)',
      description: 'Il bonus di Canto del Riposo aumenta al valore finale.'
    },
    {
      class: 'bardo',
      level: 18,
      privilege: 'Segreti Magici Ulteriori',
      description: 'Impari 2 ulteriori incantesimi da qualunque lista; diventano incantesimi da bardo.'
    },
    {
      class: 'bardo',
      level: 19,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'bardo',
      level: 20,
      privilege: 'Maestro dell’Ispirazione',
      description: 'Ispirazione quasi inesauribile e più potente.'
    },

    // --- Chierico ---
    {
      class: 'chierico',
      level: 1,
      privilege: 'Dominio Divino',
      description: 'Scegli un Dominio che conferisce incantesimi e privilegi unici.'
    },
    {
      class: 'chierico',
      level: 2,
      privilege: 'Canale Divino',
      description: 'Usi il potere divino per effetti speciali; include Scacciare Non Morti.'
    },
    {
      class: 'chierico',
      level: 3,
      privilege: 'Privilegio del Dominio',
      description: 'Il tuo Dominio conferisce un nuovo privilegio.'
    },
    {
      class: 'chierico',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'chierico',
      level: 5,
      privilege: 'Distruzione dei Non Morti',
      description: 'Non morti di GS basso vengono distrutti quando falliscono Scacciare.'
    },
    {
      class: 'chierico',
      level: 6,
      privilege: 'Canale Divino (usi aggiuntivi)',
      description: 'Ottieni un uso addizionale di Canale Divino tra un riposo lungo e l’altro.'
    },
    {
      class: 'chierico',
      level: 7,
      privilege: 'Privilegio del Dominio',
      description: 'Il tuo Dominio conferisce un nuovo privilegio.'
    },
    {
      class: 'chierico',
      level: 8,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'chierico',
      level: 8,
      privilege: 'Distruzione dei Non Morti (migliorata)',
      description: 'La soglia di GS dei non morti che vengono distrutti aumenta.'
    },
    {
      class: 'chierico',
      level: 9,
      privilege: 'Privilegio del Dominio',
      description: 'Il tuo Dominio conferisce un nuovo privilegio.'
    },
    {
      class: 'chierico',
      level: 10,
      privilege: 'Intervento Divino',
      description: 'Puoi richiedere l’aiuto diretto della tua divinità una volta per riposo lungo.'
    },
    {
      class: 'chierico',
      level: 11,
      privilege: 'Distruzione dei Non Morti (migliorata)',
      description: 'La soglia di GS dei non morti che vengono distrutti aumenta.'
    },
    {
      class: 'chierico',
      level: 12,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'chierico',
      level: 13,
      privilege: 'Privilegio del Dominio',
      description: 'Il tuo Dominio conferisce un nuovo privilegio.'
    },
    {
      class: 'chierico',
      level: 14,
      privilege: 'Distruzione dei Non Morti (migliorata)',
      description: 'La soglia di GS dei non morti che vengono distrutti aumenta.'
    },
    {
      class: 'chierico',
      level: 15,
      privilege: 'Privilegio del Dominio',
      description: 'Il tuo Dominio conferisce un nuovo privilegio.'
    },
    {
      class: 'chierico',
      level: 16,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'chierico',
      level: 17,
      privilege: 'Distruzione dei Non Morti (migliorata)',
      description: 'La soglia di GS dei non morti che vengono distrutti aumenta.'
    },
    {
      class: 'chierico',
      level: 18,
      privilege: 'Canale Divino (usi aggiuntivi)',
      description: 'Ottieni un ulteriore uso di Canale Divino tra i riposi.'
    },
    {
      class: 'chierico',
      level: 19,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'chierico',
      level: 20,
      privilege: 'Campione del Divino',
      description: 'Potere divino al suo apice, privilegi del Dominio potenziati.'
    },

    // --- Druido ---
    {
      class: 'druido',
      level: 1,
      privilege: 'Linguaggio Druidico',
      description: 'Conosci il linguaggio segreto dei druidi.'
    },
    {
      class: 'druido',
      level: 2,
      privilege: 'Forma Selvatica',
      description: 'Ti trasformi in bestie conosciute un certo numero di volte per riposo.'
    },
    {
      class: 'druido',
      level: 2,
      privilege: 'Circolo Druidico',
      description: 'Scegli un Circolo che conferisce privilegi unici.'
    },
    {
      class: 'druido',
      level: 3,
      privilege: 'Approfondimento del Circolo',
      description: 'Il tuo Circolo Druidico ti concede ulteriori tecniche e conoscenze.'
    },
    {
      class: 'druido',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'druido',
      level: 5,
      privilege: 'Forma Migliorata',
      description: 'Miglioramenti alla Forma Selvatica e agli incantesimi.'
    },
    {
      class: 'druido',
      level: 6,
      privilege: 'Privilegio del Circolo',
      description: 'Il tuo Circolo Druidico conferisce un nuovo privilegio.'
    },
    {
      class: 'druido',
      level: 7,
      privilege: 'Approfondimento del Circolo',
      description: 'Ottieni un ulteriore beneficio legato al tuo Circolo.'
    },
    {
      class: 'druido',
      level: 8,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'druido',
      level: 9,
      privilege: 'Approfondimento del Circolo',
      description: 'Affini le pratiche del tuo Circolo.'
    },
    {
      class: 'druido',
      level: 10,
      privilege: 'Privilegio del Circolo',
      description: 'Il tuo Circolo Druidico conferisce un nuovo privilegio.'
    },
    {
      class: 'druido',
      level: 11,
      privilege: 'Incantesimi Superiori',
      description: 'Accedi a incantesimi di livello più alto.'
    },
    {
      class: 'druido',
      level: 12,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'druido',
      level: 13,
      privilege: 'Approfondimento del Circolo',
      description: 'Ulteriori insegnamenti dal tuo Circolo.'
    },
    {
      class: 'druido',
      level: 14,
      privilege: 'Privilegio del Circolo',
      description: 'Il tuo Circolo Druidico conferisce un nuovo privilegio.'
    },
    {
      class: 'druido',
      level: 15,
      privilege: 'Approfondimento del Circolo',
      description: 'Migliori capacità legate al tuo Circolo.'
    },
    {
      class: 'druido',
      level: 16,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'druido',
      level: 17,
      privilege: 'Incantesimi Superiori',
      description: 'Accedi a incantesimi di livello più alto.'
    },
    {
      class: 'druido',
      level: 18,
      privilege: 'Corpo Senza Tempo',
      description: 'Invecchi più lentamente e subisci meno effetti del tempo.'
    },
    {
      class: 'druido',
      level: 18,
      privilege: 'Incantesimi Bestiali',
      description: 'Puoi lanciare molti incantesimi anche in Forma Selvatica.'
    },
    {
      class: 'druido',
      level: 19,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'druido',
      level: 20,
      privilege: 'Arcidruido',
      description: 'Usi Forma Selvatica illimitati e grandi poteri naturali.'
    },

    // --- Mago ---
    {
      class: 'mago',
      level: 1,
      privilege: 'Recupero Arcano',
      description: 'Recuperi slot incantesimo dopo un riposo breve una volta al giorno.'
    },
    {
      class: 'mago',
      level: 2,
      privilege: 'Tradizione Arcana',
      description: 'Scegli una scuola di magia che conferisce privilegi.'
    },
    {
      class: 'mago',
      level: 3,
      privilege: 'Studio Arcano',
      description: 'Approfondisci le tue ricerche e tecniche arcane.'
    },
    {
      class: 'mago',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'mago',
      level: 5,
      privilege: 'Magia Superiore',
      description: 'Accesso agli incantesimi di 3° livello e superiori.'
    },
    {
      class: 'mago',
      level: 6,
      privilege: 'Privilegio della Tradizione Arcana',
      description: 'La tua scuola di magia conferisce un nuovo privilegio.'
    },
    {
      class: 'mago',
      level: 7,
      privilege: 'Studio Arcano',
      description: 'Perfezioni le pratiche di lancio e studio degli incantesimi.'
    },
    {
      class: 'mago',
      level: 8,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'mago',
      level: 9,
      privilege: 'Magia Avanzata',
      description: 'Accedi a incantesimi di livello superiore.'
    },
    {
      class: 'mago',
      level: 10,
      privilege: 'Privilegio della Tradizione Arcana',
      description: 'La tua scuola di magia conferisce un nuovo privilegio.'
    },
    {
      class: 'mago',
      level: 11,
      privilege: 'Incantesimi Superiori',
      description: 'Accedi a incantesimi di livello più alto.'
    },
    {
      class: 'mago',
      level: 12,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'mago',
      level: 13,
      privilege: 'Studio Arcano',
      description: 'Rafforzi la comprensione di formule e rituali.'
    },
    {
      class: 'mago',
      level: 14,
      privilege: 'Privilegio della Tradizione Arcana',
      description: 'La tua scuola di magia conferisce un nuovo privilegio.'
    },
    {
      class: 'mago',
      level: 15,
      privilege: 'Studio Arcano',
      description: 'Affini ulteriormente la tua padronanza arcana.'
    },
    {
      class: 'mago',
      level: 16,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'mago',
      level: 17,
      privilege: 'Incantesimi Superiori',
      description: 'Accedi a incantesimi di livello più alto.'
    },
    {
      class: 'mago',
      level: 18,
      privilege: 'Maestria degli Incantesimi',
      description: 'Lanci alcuni incantesimi di basso livello senza spendere slot.'
    },
    {
      class: 'mago',
      level: 19,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'mago',
      level: 20,
      privilege: 'Maestro Arcano',
      description: 'Padroneggi la magia arcana con poteri eccezionali.'
    },

    // --- Stregone ---
    {
      class: 'stregone',
      level: 1,
      privilege: 'Origine Stregonesca',
      description: 'Scegli un’origine che conferisce poteri innati.'
    },
    {
      class: 'stregone',
      level: 2,
      privilege: 'Punti Stregoneria e Metamagia',
      description: 'Ottieni Punti Stregoneria e opzioni di Metamagia.'
    },
    {
      class: 'stregone',
      level: 3,
      privilege: 'Metamagia Aggiuntiva',
      description: 'Ottieni ulteriori opzioni di Metamagia.'
    },
    {
      class: 'stregone',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'stregone',
      level: 5,
      privilege: 'Magia Potenziata',
      description: 'Accesso a incantesimi più potenti e uso avanzato della Metamagia.'
    },
    {
      class: 'stregone',
      level: 6,
      privilege: 'Punti Stregoneria (aumentati)',
      description: 'Ottieni più Punti Stregoneria per alimentare la Metamagia.'
    },
    {
      class: 'stregone',
      level: 7,
      privilege: 'Magia Avanzata',
      description: 'Accedi a incantesimi di livello superiore e perfezioni l’uso della Metamagia.'
    },
    {
      class: 'stregone',
      level: 8,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'stregone',
      level: 9,
      privilege: 'Incantesimi Superiori',
      description: 'Ottieni accesso a incantesimi di livello più alto.'
    },
    {
      class: 'stregone',
      level: 10,
      privilege: 'Metamagia (opzioni aggiuntive)',
      description: 'Ottieni ulteriori opzioni o usi di Metamagia.'
    },
    {
      class: 'stregone',
      level: 11,
      privilege: 'Magia Avanzata',
      description: 'Perfezioni ulteriormente le tue capacità innate con gli incantesimi.'
    },
    {
      class: 'stregone',
      level: 12,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'stregone',
      level: 13,
      privilege: 'Incantesimi Superiori',
      description: 'Accedi a incantesimi di livello ancora più alto.'
    },
    {
      class: 'stregone',
      level: 14,
      privilege: 'Potenziamenti dell’Origine',
      description: 'La tua Origine Stregonesca conferisce benefici aggiuntivi.'
    },
    {
      class: 'stregone',
      level: 15,
      privilege: 'Metamagia Affinata',
      description: 'Ottieni maggiore efficienza nell’uso dei Punti Stregoneria e della Metamagia.'
    },
    {
      class: 'stregone',
      level: 16,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'stregone',
      level: 17,
      privilege: 'Incantesimi Epici',
      description: 'Accedi ai massimi livelli di incantesimi consentiti alla classe.'
    },
    {
      class: 'stregone',
      level: 18,
      privilege: 'Magia Trascendente',
      description: 'I tuoi incantesimi diventano più difficili da contrastare e dispellere.'
    },
    {
      class: 'stregone',
      level: 19,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'stregone',
      level: 20,
      privilege: 'Ascendenza Sovrannaturale',
      description: 'I tuoi poteri innati raggiungono l’apice.'
    },

    // --- Warlock ---
    {
      class: 'warlock',
      level: 1,
      privilege: 'Patto con il Patrono',
      description: 'Stringi un patto con un’entità; ottieni incantesimi e privilegi.'
    },
    {
      class: 'warlock',
      level: 2,
      privilege: 'Invocazioni Occulte',
      description: 'Ottieni invocazioni che modificano e potenziano le tue capacità.'
    },
    {
      class: 'warlock',
      level: 3,
      privilege: 'Patto (Catena/Lama/Tomo)',
      description: 'Scegli un patto che definisce ulteriormente i tuoi poteri.'
    },
    {
      class: 'warlock',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'warlock',
      level: 5,
      privilege: 'Misteri Aumentati',
      description: 'Slot di incantesimo più potenti e nuove invocazioni.'
    },
    {
      class: 'warlock',
      level: 6,
      privilege: 'Invocazioni Aggiuntive',
      description: 'Ottieni o migliori le tue Invocazioni Occulte.'
    },
    {
      class: 'warlock',
      level: 7,
      privilege: 'Invocazioni Occulte (ulteriori)',
      description: 'Ottieni un’ulteriore Invocazione o migliori una esistente.'
    },
    {
      class: 'warlock',
      level: 8,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'warlock',
      level: 9,
      privilege: 'Potere Occulto Superiore',
      description: 'I tuoi slot di incantesimo aumentano di potenza e durata.'
    },
    {
      class: 'warlock',
      level: 10,
      privilege: 'Privilegio del Patrono',
      description: 'Il tuo Patrono conferisce un nuovo privilegio.'
    },
    {
      class: 'warlock',
      level: 11,
      privilege: 'Arcanum Mistico (6°)',
      description: 'Ottieni un incantesimo a livello fisso (6°) lanciabile 1/giorno.'
    },
    {
      class: 'warlock',
      level: 12,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'warlock',
      level: 13,
      privilege: 'Arcanum Mistico (7°)',
      description: 'Ottieni un incantesimo a livello fisso (7°) lanciabile 1/giorno.'
    },
    {
      class: 'warlock',
      level: 14,
      privilege: 'Privilegio del Patrono',
      description: 'Il tuo Patrono conferisce un nuovo privilegio.'
    },
    {
      class: 'warlock',
      level: 15,
      privilege: 'Arcanum Mistico (8°)',
      description: 'Ottieni un incantesimo a livello fisso (8°) lanciabile 1/giorno.'
    },
    {
      class: 'warlock',
      level: 15,
      privilege: 'Arcanum Mistico (8°)',
      description: 'Ottieni un incantesimo a livello fisso (8°) lanciabile 1/giorno.'
    },
    {
      class: 'warlock',
      level: 16,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'warlock',
      level: 17,
      privilege: 'Arcanum Mistico (9°)',
      description: 'Ottieni un incantesimo a livello fisso (9°) lanciabile 1/giorno.'
    },
    {
      class: 'warlock',
      level: 18,
      privilege: 'Invocazioni Occulte (maestria)',
      description: 'Ottieni un’ulteriore Invocazione e affini le tue capacità occulte.'
    },
    {
      class: 'warlock',
      level: 19,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'warlock',
      level: 20,
      privilege: 'Arcanum Eldritch',
      description: 'Accedi ad Arcanum di alto livello una volta per riposo lungo.'
    },

    // --- Artificiere ---
    {
      class: 'artefice',
      level: 1,
      privilege: 'Tinker e Incantesimi',
      description: 'Competenze con strumenti e accesso a incantesimi da Artificiere.'
    },
    {
      class: 'artefice',
      level: 2,
      privilege: 'Infondere Oggetti',
      description: 'Infondi oggetti con poteri magici temporanei.'
    },
    {
      class: 'artefice',
      level: 3,
      privilege: 'Specializzazione',
      description: 'Scegli una specializzazione (Alchimista, Artefice da Battaglia, Corazzato).'
    },
    {
      class: 'artefice',
      level: 4,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'artefice',
      level: 5,
      privilege: 'Strumenti Potenziati',
      description: 'Migliori i benefici degli oggetti infusi e delle tue creazioni.'
    },
    {
      class: 'artefice',
      level: 6,
      privilege: 'Maestria negli Strumenti',
      description: 'Raddoppi il bonus di competenza con gli strumenti con cui sei competente.'
    },
    {
      class: 'artefice',
      level: 7,
      privilege: 'Colpo di Genio',
      description: 'Usa la reazione per aggiungere il tuo mod INT a un TS o prova di un alleato vicino.'
    },
    {
      class: 'artefice',
      level: 8,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'artefice',
      level: 9,
      privilege: 'Perito di Oggetti Magici',
      description: 'Più rapido nell’identificare/creare oggetti magici; limiti di sintonia aumentati.'
    },
    {
      class: 'artefice',
      level: 10,
      privilege: 'Esperto di Oggetti Magici',
      description: 'Ulteriori miglioramenti nell’uso e nella sintonia con oggetti magici.'
    },
    {
      class: 'artefice',
      level: 11,
      privilege: 'Oggetto che Immagazzina Incantesimi',
      description: 'Crei un oggetto che può contenere e rilasciare un incantesimo più volte.'
    },
    {
      class: 'artefice',
      level: 12,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'artefice',
      level: 13,
      privilege: 'Infusioni Migliorate',
      description: 'Ottieni nuove infusioni e potenzi le esistenti.'
    },
    {
      class: 'artefice',
      level: 14,
      privilege: 'Intenditore di Oggetti Magici',
      description: 'Puoi sintonizzarti a più oggetti magici e ne ignori alcuni prerequisiti.'
    },
    {
      class: 'artefice',
      level: 15,
      privilege: 'Progetto Geniale',
      description: 'Un progetto migliora le tue capacità e i tuoi infusi.'
    },
    {
      class: 'artefice',
      level: 16,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'artefice',
      level: 17,
      privilege: 'Ingegneria Suprema',
      description: 'Le tue creazioni raggiungono un’efficacia straordinaria.'
    },
    {
      class: 'artefice',
      level: 18,
      privilege: 'Maestro di Oggetti Magici',
      description: 'Ulteriori slot di sintonia e maggiore efficacia con gli oggetti.'
    },
    {
      class: 'artefice',
      level: 19,
      privilege: 'Incremento Caratteristica',
      description: 'Aumenta di 2 un punteggio di caratteristica o di 1 due punteggi.'
    },
    {
      class: 'artefice',
      level: 20,
      privilege: 'Anima dell’Artefice',
      description: 'Aumenti la resilienza aggiungendo INT ai PF e mantieni la sintonia a oggetti in situazioni difficili.'
    },
    {
      class: 'artefice',
      level: 20,
      privilege: 'Genio dell’Invenzione',
      description: 'Accesso a creazioni e infusi straordinari.'
    },
  ],

  /** @type {SottoclassiMap} */
  sottoclassi: {
    barbaro: {
      'cammino del berserker': [
        {
          level: 3,
          privilege: 'frenesia',
          description: 'quando entri in ira, puoi scegliere se entrare in frenesia. così il barbaro può effettuare un singolo attacco con arma da mischia come azione bonus durante ciascun tuo turno oltre quello iniziale. al termine, subisci un livello di indebolimento.'
        },
        {
          level: 6,
          privilege: 'ira incontenibile',
          description: 'non puoi essere affascinato o spaventato mentre sei in ira. se sei già affascinato o spaventato mentre entri in ira, l’effetto è sospeso per la durata dell’ira.'
        },
        {
          level: 10,
          privilege: 'presenza intimidatoria',
          description: 'può usare un’azione per provare a spaventare una creatura entro 9m, se fallisce un ts su sag (cd 8 + bc + mod car), resta spaventata fino al tuo prossimo turno. puoi rinnovare l’effetto. cessa se la creatura termina il suo turno fuori dalla visuale o a più di 18m. se la creatura lo supera, sarà immune per 24h.'
        },
        {
          level: 14,
          privilege: 'ritorsione',
          description: 'quando subisci danno da una creatura che si trova entro 1,5 metri da te, puoi usare la tua reazione per effettuare un attacco con arma da mischia contro quella creatura.'
        }
      ],
      'cammino dello zelota': [
        {
          level: 3,
          privilege: 'furia divina',
          description: 'quando il barbaro è in ira e colpisce una creatura con un’arma, gli infligge danni extra pari a 1d6 + metà del livello da barbaro. quando sceglie questo privilegio, sceglie se i danni extra saranno radianti o necrotici.'
        },
        {
          level: 3,
          privilege: 'guerriero degli dei',
          description: 'se una creatura utilizza un incantesimo per riportare in vita il barbaro, non necessita di componenti materiali.'
        },
        {
          level: 6,
          privilege: 'concentrazione fanatica',
          description: 'se il barbaro fallisce un tiro salvezza mentre è in ira, può ritirare il dado ed usare il nuovo risultato. può usare il privilegio solo una volta per ira.'
        },
        {
          level: 10,
          privilege: 'presenza zelante',
          description: 'dopo un riposo lungo, con un’azione bonus il barbaro lancia un urlo infuso di energia divina. fino a 10 creature entro 18m in grado di sentirlo ottengono vantaggio ai tiri per colpire e tiri salvezza fino all’inizio del suo prossimo turno.'
        },
        {
          level: 14,
          privilege: 'ira imperitura',
          description: 'mentre il barbaro è in ira e possiede 0 pf, può rimanere in vita per la durata dell’ira e muore solo se alla fine dell’ira ha ancora 0 pf. deve comunque fare i tiri salvezza contro morte e subisce i normali effetti di chi viene colpito a 0 pf.'
        }
      ],
      'cammino del combattente totemico': [
        {
          level: 3,
          privilege: 'cercatore di spiriti',
          description: 'rituali: percezione delle bestie e parlare con gli animali.\n- percezione delle bestie: percepisce attraverso una bestia consenziente.\n- parlare con gli animali: comunicazione verbale per 10 minuti con animali, che potrebbero anche farti un favore.'
        },
        {
          level: 3,
          privilege: 'spirito totemico',
          description: 'richiede un oggetto creato con resti animali. durante l’ira, puoi scegliere tra:\n- aquila: svantaggio agli attacchi di opportunità contro di te, puoi usare scatto come azione bonus.\n- lupo: vantaggio agli attacchi in mischia degli alleati entro 1,5m da te.\n- orso: resistenza a tutti i danni eccetto psichici.'
        },
        {
          level: 6,
          privilege: 'aspetto della bestia',
          description: '- aquila: vedi dettagli fino a 1,5km, nessun svantaggio in luce fioca.\n- lupo: segui tracce a passo veloce, muoviti furtivamente a passo normale.\n- orso: raddoppi capacità di carico, vantaggio a spingere, sollevare, trascinare, spezzare oggetti.'
        },
        {
          level: 10,
          privilege: 'viandante spirituale',
          description: 'puoi lanciare il rituale "comunione con la natura", apprendendo fino a 3 aspetti dell’area (entro 4,5km in superficie o 90m nel sottosuolo):\n- terreni e acque\n- creature (animali, vegetali, celestiali, immondi, non morti, ecc.)\n- popolazioni\n- costruzioni'
        },
        {
          level: 14,
          privilege: 'sintonia totemica',
          description: '- aquila: puoi volare per brevi tratti alla velocità del cammino.\n- lupo: durante l’ira, se colpisci una creatura con un’arma da mischia, puoi usare un’azione bonus per buttarla a terra (taglia grande o inferiore).\n- orso: un nemico entro 1,5m ha svantaggio a colpire tutte le creature che non abbiano questo privilegio.'
        }
      ],
      'guardiano ancestrale': [
        {
          level: 3,
          privilege: 'protettori ancestrali',
          description: 'quando entri in ira, il primo nemico colpito ha svantaggio contro bersagli diversi da te e le sue vittime hanno resistenza ai danni finché non termina il tuo turno successivo.'
        },
        {
          level: 6,
          privilege: 'spiriti protettori',
          description: 'i tuoi spiriti ancestrali ostacolano la fuga dei nemici che danneggi mentre sei in ira; hanno svantaggio a colpirti se provano a muoversi o teletrasportarsi.'
        },
        {
          level: 10,
          privilege: 'consultare gli spiriti',
          description: 'puoi lanciare *augurio* o *parlare coi morti* come rituale, senza componenti materiali. bonus alle prove di intuizione o persuasione quando usi la saggezza degli spiriti.'
        },
        {
          level: 14,
          privilege: 'antenati vendicativi',
          description: 'quando una creatura danneggia un alleato mentre è soggetta al tuo effetto di protettore ancestrale, subisce danni da forza pari alla metà del tuo livello da barbaro.'
        }
      ],
      'araldo della tempesta': [
        {
          level: 3,
          privilege: 'aura tempestosa',
          description: 'quando entri in ira, attivi un’aura elementale (deserto, mare o tundra). come azione bonus, infliggi effetti diversi in base all’aura.'
        },
        {
          level: 6,
          privilege: 'aura tempestosa migliorata',
          description: 'l’aura attiva effetti passivi per te e chi ti sta vicino (es. vantaggio su ts contro incantesimi, bonus a velocità, resistenza al freddo).'
        },
        {
          level: 10,
          privilege: 'anima tempestosa',
          description: 'sei immune agli effetti dannosi della tua aura, e puoi estenderne i benefici a un alleato entro 9m.'
        },
        {
          level: 14,
          privilege: 'tempesta furiosa',
          description: 'quando subisci danni da una creatura entro 1,5m, puoi usare la reazione per infliggerle i danni della tua aura.'
        }
      ],
    }, //barbaro
    monaco: {
      'via dell’ombra': [
        {
          level: 3,
          privilege: 'arti dell’ombra',
          description: 'accedi a incantesimi usando punti ki: illusione minore, oscurità, passare senza tracce, scurovisione e silenzio.'
        },
        {
          level: 6,
          privilege: 'passo dell’ombra',
          description: 'in luce fioca o oscurità, puoi teletrasportarti fino a 18m come azione bonus. vantaggio al primo attacco in mischia.'
        },
        {
          level: 11,
          privilege: 'manto di ombre',
          description: 'in luce fioca o oscurità, puoi diventare invisibile con un’azione. l’effetto termina se attacchi, lanci incantesimi o entri in luce intensa.'
        },
        {
          level: 17,
          privilege: 'opportunista',
          description: 'se una creatura entro 1,5m viene colpita da un altro, puoi usare la reazione per attaccarla in mischia.'
        }
      ],
      'via della mano aperta': [
        {
          level: 3,
          privilege: 'tecnica della mano aperta',
          description: 'dopo raffica di colpi, puoi: far cadere prono (ts des), spingere di 4,5m (ts for), o impedire reazioni fino a fine turno.'
        },
        {
          level: 6,
          privilege: 'integrità del corpo',
          description: 'una volta per riposo lungo, puoi usare un’azione per recuperare pf pari al triplo del tuo livello da monaco.'
        },
        {
          level: 11,
          privilege: 'tranquillità',
          description: 'dopo riposo lungo, ottieni l’effetto di *santuario* fino al prossimo riposo lungo. cd = 8 + mod sag + bonus competenza.'
        },
        {
          level: 17,
          privilege: 'palmo tremante',
          description: 'colpo senz’armi con 3 ki: se il bersaglio fallisce ts cos, scende a 0 pf. altrimenti subisce 10d10 danni necrotici. puoi sospendere l’effetto per 1 ora.'
        }
      ]
    }, //monaco
  },

  sottorazze: [
    {
      nome: "dragonide",
      velocita: [
        { key: 'camminare', value: 9 },
        { key: 'nuotare', value: 4.5 },
        { key: 'scalare', value: 4.5 }
      ],
      eta: "Maturità: 15 anni, Vita media: 80 anni",
      taglia: "Media",
      linguaggi: ["Comune", "Draconico"],
      privilegi: [
        { name: "arma a soffio", description: "Potete usare la vostra azione per esalare energia distruttiva..." },
        { name: "resistenza al danno", description: "Avete resistenza a un tipo di danno associato..." }
      ]
    },
    {
      nome: "elfo alto",
      velocita: [
        { key: 'camminare', value: 9 },
        { key: 'nuotare', value: 4.5 },
        { key: 'scalare', value: 4.5 }
      ],
      eta: "Maturità: ca. 100 anni (adulto culturale), Vita media: fino a 750 anni",
      taglia: "Media",
      linguaggi: ["Comune", "Elfico"],
      privilegi: [
        { name: "scurovisione", description: "Potete vedere in condizioni di buio o luce fioca..." },
        { name: "trance", description: "Meditazione profonda di 4 h al posto del sonno umano..." },
        { name: "retaggio fatato", description: "Vantaggio contro affascinato e immunità al sonno magico..." },
        { name: "sensi acuti", description: "Competenza nell’abilità Percezione." },
        { name: "addestramento armi elfiche", description: "Competenza con spada lunga, spada corta, arco corto e lungo." },
        { name: "trucchetto", description: "Conoscete un trucchetto da mago; Intelligenza è la caratteristica usata." },
        { name: "linguaggio extra", description: "Potete parlare, leggere e scrivere un linguaggio extra." }
      ]
    },
    {
      nome: "elfo dei boschi",
      velocita: [
        { key: 'camminare', value: 10.5 },
        { key: 'nuotare', value: 6 },
        { key: 'scalare', value: 6 }
      ],
      eta: "Maturità: ca. 100 anni (adulto culturale), Vita media: fino a 750 anni",
      taglia: "Media",
      linguaggi: ["Comune", "Elfico"],
      privilegi: [
        { name: "scurovisione", description: "Potete vedere in condizioni di buio o luce fioca..." },
        { name: "trance", description: "Meditazione profonda di 4 h al posto del sonno umano..." },
        { name: "retaggio fatato", description: "Vantaggio contro affascinato e immunità al sonno magico..." },
        { name: "sensi acuti", description: "Competenza nell’abilità Percezione." },
        { name: "addestramento armi elfiche", description: "Competenza con spada lunga, spada corta, arco corto e lungo." },
        { name: "piede lesto", description: "Velocità base aumentata (es. 10,5 m per elfo dei boschi)." },
        { name: "maschera della selva", description: "Potete nascondervi da sporadiche oscurazioni naturali." }
      ]
    },
    {
      nome: "elfo oscuro (Drow)",
      velocita: [
        { key: 'camminare', value: 9 },
        { key: 'nuotare', value: 4.5 },
        { key: 'scalare', value: 4.5 }
      ],
      eta: "Maturità: ca. 100 anni (adulto culturale), Vita media: fino a 750 anni",
      taglia: "Media",
      linguaggi: ["Comune", "Elfico", "Sottocomune"],
      privilegi: [
        { name: "scurovisione", description: "Potete vedere in condizioni di buio o luce fioca..." },
        { name: "trance", description: "Meditazione profonda di 4 h al posto del sonno umano..." },
        { name: "retaggio fatato", description: "Vantaggio contro affascinato e immunità al sonno magico..." },
        { name: "incantesimi innati", description: "Potete lanciare magie innate (es. Luci Danzanti, Oscurità) usando Carisma." },
        { name: "sensibilità alla luce del sole", description: "Svantaggio ai tiri per colpire e Percezione quando esposti alla luce solare." }
      ]
    },
    {
      nome: "gnomo delle rocce",
      velocita: [
        { key: 'camminare', value: 7.5 },
        { key: 'nuotare', value: 3 },
        { key: 'scalare', value: 3 }
      ],
      eta: "Maturità: simile agli umani (ca. 40 anni), Vita media: 350‑500 anni",
      taglia: "Piccola",
      linguaggi: ["Comune", "Gnomesco"],
      privilegi: [
        { name: "scurovisione", description: "Potete vedere in condizioni di buio o luce fioca..." },
        { name: "astuzia gnomesca", description: "Vantaggio ai tiri salvezza su Intelligenza, Saggezza e Carisma contro la magia." },
        { name: "sapere da artefice", description: "Raddoppiate il bonus di competenza su prove di Storia per oggetti magici/alchemici." },
        { name: "inventore", description: "Competenza con strumenti da inventore e conoscenza per creare congegni ad orologeria." }
      ]
    },
    {
      nome: "gnomo delle foreste",
      velocita: [
        { key: 'camminare', value: 7.5 },
        { key: 'nuotare', value: 3 },
        { key: 'scalare', value: 3 }
      ],
      eta: "Maturità: simile agli umani (ca. 40 anni), Vita media: 350‑500 anni",
      taglia: "Piccola",
      linguaggi: ["Comune", "Gnomesco"],
      privilegi: [
        { name: "scurovisione", description: "Potete vedere in condizioni di buio o luce fioca..." },
        { name: "astuzia gnomesca", description: "Vantaggio ai tiri salvezza su Intelligenza, Saggezza e Carisma contro la magia." },
        { name: "illusionista naturale", description: "Conoscete il trucchetto Illusione Minore; Intelligenza è la caratteristica usata." },
        { name: "parla con gli animali", description: "Potete comunicare idee semplici con animali Piccoli tramite suoni e gesti." }
      ]
    },
    {
      nome: "halfling piedelesto",
      velocita: [
        { key: 'camminare', value: 7.5 },
        { key: 'nuotare', value: 3 },
        { key: 'scalare', value: 3 }
      ],
      eta: "Maturità: 20 anni, Vita media: circa 100 anni",
      taglia: "Piccola",
      linguaggi: ["Comune", "Halfling"],
      privilegi: [
        { name: "fortunato", description: "Se tirate un 1, potete ritirare il dado e usare il nuovo risultato." },
        { name: "coraggioso", description: "Vantaggio ai tiri salvezza contro l’essere spaventato." },
        { name: "versatilità halfling", description: "Potete muovervi attraverso lo spazio di creature di taglia maggiore." },
        { name: "naturalmente furtivo", description: "Potete nascondervi anche quando siete oscurati da una creatura più grande." }
      ]
    },
    {
      nome: "halfling tozzo",
      velocita: [
        { key: 'camminare', value: 7.5 },
        { key: 'nuotare', value: 3 },
        { key: 'scalare', value: 3 }
      ],
      eta: "Maturità: 20 anni, Vita media: circa 100 anni",
      taglia: "Piccola",
      linguaggi: ["Comune", "Halfling"],
      privilegi: [
        { name: "fortunato", description: "Se tirate un 1, potete ritirare il dado e usare il nuovo risultato." },
        { name: "coraggioso", description: "Vantaggio ai tiri salvezza contro l’essere spaventato." },
        { name: "versatilità halfling", description: "Potete muovervi attraverso lo spazio di creature di taglia maggiore." },
        { name: "resistenza del tozzo", description: "Vantaggio ai tiri salvezza contro il veleno e resistenza ai danni da veleno." }
      ]
    },
    {
      nome: "mezzelfo",
      velocita: [
        { key: 'camminare', value: 9 },
        { key: 'nuotare', value: 4.5 },
        { key: 'scalare', value: 4.5 }
      ],
      eta: "Maturità: circa 20 anni, Vita media: oltre 180 anni",
      taglia: "Media (150–180 cm)",
      linguaggi: ["Comune", "Elfico", "linguaggio extra a scelta"],
      privilegi: [
        { name: "scurovisione", description: "Potete vedere in condizioni di buio o luce fioca..." },
        { name: "stirpe fatata", description: "Vantaggio contro affascinato e immunità al sonno magico." },
        { name: "versatilità", description: "Competenza in due abilità a scelta." }
      ]
    },
    {
      nome: "mezzorco",
      velocita: [
        { key: 'camminare', value: 9 },
        { key: 'nuotare', value: 4.5 },
        { key: 'scalare', value: 4.5 }
      ],
      eta: "Maturità: circa 14 anni, Vita media: fino a ~75 anni",
      taglia: "Media (150–oltre 180 cm)",
      linguaggi: ["Comune", "Orchesco"],
      privilegi: [
        { name: "scurovisione", description: "Potete vedere in condizioni di buio o luce fioca..." },
        { name: "minaccioso", description: "Competenza nell’abilità Intimidire." },
        { name: "resistenza inesorabile", description: "Se ridotto a 0 PF (non ucciso sul colpo), potete tornare a 1 PF una volta per riposo lungo." },
        { name: "attacchi selvaggi", description: "Al critico con arma da mischia, tirate un dado aggiuntivo per il danno." }
      ]
    },
    {
      nome: "umano",
      velocita: [
        { key: 'camminare', value: 9 },
        { key: 'nuotare', value: 4.5 },
        { key: 'scalare', value: 4.5 }
      ],
      eta: "Maturità: ~18 anni, Vita media: ~80 anni",
      taglia: "Media",
      linguaggi: ["Comune", "linguaggio extra a scelta"],
      privilegi: []
    },
    {
      nome: "nano delle colline",
      velocita: [
        { key: 'camminare', value: 7.5 },
        { key: 'nuotare', value: 3 },
        { key: 'scalare', value: 3 }
      ],
      eta: "Maturità: simile agli umani (giovani fino a 50 anni), Vita media: circa 350 anni",
      taglia: "Media (120–150 cm, circa 70 kg)",
      linguaggi: ["Comune", "Nanico"],
      privilegi: [
        { name: "scurovisione", description: "Potete vedere in condizioni di buio o luce fioca..." },
        { name: "resilienza nanica", description: "Vantaggio ai tiri salvezza contro il veleno e resistenza ai danni da veleno." },
        { name: "addestramento combattimento nanico", description: "Competenza con ascia da battaglia/lancio, martello da lancio/guerra." },
        { name: "competenza strumenti nanici", description: "Competenza con strumenti da fabbro, birraio o muratore." },
        { name: "esperto minatore", description: "Raddoppio del bonus di competenza su Storia relativa a muratura." },
        { name: "robustezza nanica", description: "PF massimi aumentano di 1 e continuano a incrementare di 1 a ogni livello." }
      ]
    },
    {
      nome: "nano delle montagne",
      velocita: [
        { key: 'camminare', value: 7.5 },
        { key: 'nuotare', value: 3 },
        { key: 'scalare', value: 3 }
      ],
      eta: "Maturità: simile agli umani (giovani fino a 50 anni), Vita media: circa 350 anni",
      taglia: "Media (120–150 cm, circa 70 kg)",
      linguaggi: ["Comune", "Nanico"],
      privilegi: [
        { name: "scurovisione", description: "Potete vedere in condizioni di buio o luce fioca..." },
        { name: "resilienza nanica", description: "Vantaggio ai tiri salvezza contro il veleno e resistenza ai danni da veleno." },
        { name: "addestramento combattimento nanico", description: "Competenza con ascia da battaglia/lancio, martello da lancio/guerra." },
        { name: "competenza strumenti nanici", description: "Competenza con strumenti da fabbro, birraio o muratore." },
        { name: "esperto minatore", description: "Raddoppio del bonus di competenza su Storia relativa a muratura." }
      ]
    }
  ],
  
  /** @type {{name: string, abilita: string[], strumenti: string[], linguaggi: string, equipaggiamento: string, privilegi: {name: string, description: string}[]}[]} */
  background :[
    {
      name: "accolito",
      abilita: ["intuizione", "religione"],
      strumenti: [],
      linguaggi: "due a scelta",
      equipaggiamento: "Un simbolo sacro (donatogli quando è stato ordinato come sacerdote), un libro di preghiere o una ruota della preghiera, 5 bastoncini di incenso, vesti, un abito comune, una borsa con 15 monete oro (mo)",
      privilegi: [
        {
          name: "Rifugio del Fedele",
          description: "Grazie al rispetto di coloro che condividono la sua fede, l'Accolito e i suoi compagni possono ricevere cure gratuite all’interno di un tempio o santuario. Se la sua reputazione è buona, può anche ottenere assistenza dai sacerdoti."
        }
      ]
    },
    {
      name: "artigiano della gilda",
      abilita: ["intuizione", "persuasione"],
      strumenti: ["uno strumento da artigiano a scelta"],
      linguaggi: "uno a scelta",
      equipaggiamento: "Una serie di strumenti da artigiano (a scelta), una lettera di presentazione della gilda, un abito da viaggiatore, una borsa con 15 monete oro (mo)",
      privilegi: [
        {
          name: "Appartenenza alla Gilda",
          description: "La gilda garantisce protezione e supporto legale. Per mantenere questi benefici, l’artigiano deve pagare 5 monete oro al mese."
        }
      ]
    },
    {
      name: "ciarlatano",
      abilita: ["inganno", "rapidità di mano"],
      strumenti: ["arnesi da falsario", "trucchi per il camuffamento"],
      linguaggi: "",
      equipaggiamento: "Un abito pregiato, trucchi per il camuffamento, uno strumento da truffatore a scelta (es. dadi truccati, bottiglie di liquido colorato, ecc.), una borsa con 15 monete oro (mo)",
      privilegi: [
        {
          name: "Falsa Identità",
          description: "Possiede una seconda identità completa di documenti, travestimenti e la capacità di falsificare qualsiasi documento dopo averne visto uno originale."
        }
      ]
    },
    {
      name: "criminale",
      abilita: ["furtività", "inganno"],
      strumenti: ["arnesi da scasso", "un tipo di gioco a scelta"],
      linguaggi: "",
      equipaggiamento: "Un piede di porco, un abito comune con cappuccio, una borsa con 15 monete oro (mo)",
      privilegi: [
        {
          name: "Contatto Criminale",
          description: "Ha una rete di contatti criminali affidabili. Può inviare o ricevere messaggi in ogni luogo tramite marinai, mercanti o carovanieri corrotti."
        }
      ]
    },
    {
      name: "eremita",
      abilita: ["medicina", "religione"],
      strumenti: ["borsa da erborista"],
      linguaggi: "uno a scelta",
      equipaggiamento: "Un bastone, una coperta invernale, un abito comune, un kit da erborista, una borsa con 5 monete oro (mo)",
      privilegi: [
        {
          name: "Scoperta",
          description: "Durante il proprio isolamento, ha scoperto qualcosa di molto importante riguardante il mondo, il cosmo o una conoscenza dimenticata."
        }
      ]
    },
    {
      name: "eroe popolare",
      abilita: ["addestrare animali", "sopravvivenza"],
      strumenti: ["uno strumento da artigiano a scelta", "veicoli (terrestri)"],
      linguaggi: "",
      equipaggiamento: "Uno strumento da artigiano (a scelta), una pala, un vaso di ferro, un abito comune, una borsa con 10 monete oro (mo)",
      privilegi: [
        {
          name: "Ospitalità Rurale",
          description: "Benvoluto dalla gente comune, che lo ospita volentieri e lo protegge. Può sempre trovare un rifugio sicuro tra i popolani."
        }
      ]
    },
    {
      name: "forestiero",
      abilita: ["atletica", "sopravvivenza"],
      strumenti: ["uno strumento musicale a scelta"],
      linguaggi: "uno a scelta",
      equipaggiamento: "Un bastone, una tagliola, un trofeo di un animale ucciso, un abito da viaggiatore, una borsa con 10 monete oro (mo)",
      privilegi: [
        {
          name: "Viandante",
          description: "Conosce sempre la posizione geografica e può trovare cibo e acqua per sé e i suoi compagni, a meno che non si trovi in un luogo completamente inospitale."
        }
      ]
    },
    {
      name: "intrattenitore",
      abilita: ["acrobazia", "intrattenere"],
      strumenti: ["trucchi per il camuffamento", "uno strumento musicale a scelta"],
      linguaggi: "",
      equipaggiamento: "Uno strumento musicale (a scelta), un pegno di un ammiratore, un costume, una borsa con 15 monete oro (mo)",
      privilegi: [
        {
          name: "A Grande Richiesta",
          description: "Riceve vitto e alloggio gratuiti in cambio di una performance giornaliera in taverne, locande o teatri."
        }
      ]
    },
    {
      name: "marinaio",
      abilita: ["atletica", "percezione"],
      strumenti: ["strumenti da navigatore", "veicoli (acquatici)"],
      linguaggi: "",
      equipaggiamento: "Una galloccia da marinaio, corda di seta (15 m), un portafortuna, un abito comune, una borsa con 10 monete oro (mo)",
      privilegi: [
        {
          name: "Passaggio Via Nave",
          description: "Può ottenere passaggi gratuiti via mare per sé e il gruppo, a condizione di aiutare l’equipaggio durante il viaggio."
        },
      ]
    },
    {
      name: "pirata",
      abilita: ["atletica", "percezione"],
      strumenti: ["strumenti da navigatore", "veicoli (acquatici)"],
      linguaggi: "",
      equipaggiamento: "Una galloccia da marinaio, corda di seta (15 m), un portafortuna, un abito comune, una borsa con 10 monete oro (mo)",
      privilegi: [
        {
          name: "Pessima Fama",
          description: "Temuto per la sua reputazione, riesce spesso a evitare punizioni per reati minori."
        }
      ]
    },
    {
      name: "monello",
      abilita: ["furtività", "rapidità di mano"],
      strumenti: ["arnesi da scasso", "trucchi per il camuffamento"],
      linguaggi: "",
      equipaggiamento: "Un coltellino, una mappa della città, un topolino addomesticato, un ciondolo dei genitori, un abito comune, una borsa con 10 monete oro (mo)",
      privilegi: [
        {
          name: "Segreti Cittadini",
          description: "Conosce vicoli, scorciatoie e passaggi nascosti che permettono a lui (e al gruppo) di muoversi in città al doppio della velocità normale."
        }
      ]
    },
    {
      name: "nobile",
      abilita: ["persuasione", "storia"],
      strumenti: ["un tipo di gioco a scelta"],
      linguaggi: "uno a scelta",
      equipaggiamento: "Un abito pregiato, un anello con sigillo, una pergamena con albero genealogico, una borsa con 25 monete oro (mo)",
      privilegi: [
        {
          name: "Posizione Privilegiata",
          description: "Viene trattato con rispetto da popolani e pari. Può accedere a luoghi di potere e ricevere udienza da altri nobili."
        },
        {
          name: "Privilegio Alternativo: Servitù",
          description: "Accompagnato da tre servitori fedeli che eseguono compiti semplici, ma non lo seguono in luoghi pericolosi né combattono."
        }
      ]
    },
    {
      name: "sapiente",
      abilita: ["arcano", "storia"],
      strumenti: [],
      linguaggi: "due a scelta",
      equipaggiamento: "Un calamaio d’inchiostro nero, un pennino, un coltellino, una lettera di un collega defunto, un abito comune, una borsa con 10 monete oro (mo)",
      privilegi: [
        {
          name: "Ricercatore",
          description: "Quando non conosce un'informazione, sa sempre dove trovarla, come in una biblioteca o presso un esperto. Il luogo è determinato dal Dungeon Master."
        }
      ]
    },
    {
      name: "soldato",
      abilita: ["atletica", "intimidire"],
      strumenti: ["un tipo di gioco", "veicoli (terrestri)"],
      linguaggi: "",
      equipaggiamento: "Una mostrina con i gradi, un trofeo strappato a un nemico abbattuto (un pugnale, una lama spezzata o un pezzo di una bandiera), una serie di dadi in osso o un mazzo di carte, un abito comune, una borsa con 10 monete oro (mo)",
      privilegi: [
        {
          name: "Grado militare",
          description: "Grazie alla sua carriera in ambito militare, il Soldato vede ancora riconosciuta la sua autorità fra i suoi ex commilitoni e sono ancora soggetti alla sua influenza. Inoltre, sempre dove il suo grado viene riconosciuto, il Soldato può accedere ad accampamenti e fortezze amiche."
        }
      ]
    }
  ],
  
  /**
   * Cerca i privilegi dato classe, sottoclasse e livello.
   * - Se esiste una sottoclasse per la classe data, ritorna l'array di privilegi della sottoclasse per quel livello.
   * - Altrimenti ritorna i privilegi base della classe a quel livello.
   * - Se parametri non validi, ritorna null.
   * @param {string} classe
   * @param {string} sottoclasse
   * @param {number} livello
   * @returns {{privilege: string, description: string, level: number}[] | null}
   */
  // cerca i privilegi tra classe e sottoclasse per un dato livello
  getPrivilegi(classe ='', sottoclasse ='', livello =0) {
    if (!classe || !sottoclasse || !livello) return null;
    const cl = String(classe).trim().toLowerCase();
    const sub = String(sottoclasse).trim().toLowerCase();

    // prima cerca nella sottoclasse, se specificata e valida
    const arrSub = this.sottoclassi[cl]?.[sub]?.filter(p => p.level === livello) || [];
    if (arrSub.length > 0) return arrSub;

    // altrimenti cerca nel base
    const arrBase = this.classi.filter(p => p.class === cl && p.level === livello) || [];
    return arrBase;
  },

  /**
   * Elenca le classi disponibili (chiavi dell'oggetto sottoclassi)
   * @returns {string[]}
   */
  // Elenca le classi disponibili (chiavi di sottoclassi)
  getClassi() {
    // output: ['barbaro', 'monaco', ecc...]
    return Object.keys(this.sottoclassi || {})
      .sort((a, b) => a.localeCompare(b));
  },

  /**
   * Restituisce l'elenco delle sottoclassi.
   * Se nomeCompleto=true, ritorna voci nel formato "classe sottoclasse".
   * @param {boolean | 'completi' | 'completo' | 'full'} [nomeCompleto=false]
   * @returns {string[]}
   */
  // Restituisce l'elenco delle sottoclassi
  // se nomeCompleto=true => "classe sottoclasse"
  getSottoclasse(nomeCompleto = false) {
    const full = nomeCompleto === true || nomeCompleto === 'completi' || nomeCompleto === 'completo' || nomeCompleto === 'full';
    const out = [];
    const mappa = this.sottoclassi || {};
    Object.keys(mappa).forEach(cl => {
      const subs = Object.keys(mappa[cl] || {});
      subs.forEach(sc => out.push(full ? `${cl} ${sc}` : sc));
    });
    return Array.from(new Set(out)).sort((a, b) => a.localeCompare(b));
  },

  oggetti:[
    { key: "abaco", prezzo: "2 mo", peso: 1 },
    { key: "abito comune", prezzo: "5 mo", peso: 1.5 },
    { key: "abito costume", prezzo: "5 mo", peso: 2 },
    { key: "abito da viaggiatore", prezzo: "2 mo", peso: 2 },
    { key: "abito pregiato", prezzo: "15 mo", peso: 3 },
    { key: "acciarino e pietra focaia", prezzo: "5 mr", peso: 0.5 },
    { key: "acido (fiala)", prezzo: "25 mo", peso: 0.5 },
    { key: "acqua santa (ampolla)", prezzo: "25 mo", peso: 0.5 },
    { key: "amuleto", prezzo: "5 mo", peso: 0.5 },
    { key: "anello con sigillo", prezzo: "5 mo", peso: 0.1 },
    { key: "antitossina (fiala)", prezzo: "50 mo", peso: 0.1 },
    { key: "ariete portatile", prezzo: "10 mo", peso: 17.5 },
    { key: "asta (3 metri)", prezzo: "5 mr", peso: 3.5 },
    { key: "attrezzi da scalatore", prezzo: "25 mo", peso: 6 },
    { key: "barile", prezzo: "2 mo", peso: 15 },
    { key: "bilancia da mercante", prezzo: "5 mo", peso: 1.5 },
    { key: "borsa", prezzo: "5 ma", peso: 0.5 },
    { key: "borsa del guaritore", prezzo: "5 mo", peso: 1.5 },
    { key: "borsa per componenti", prezzo: "25 mo", peso: 1 },
    { key: "bottiglia di vetro", prezzo: "2 mo", peso: 1 },
    { key: "brocca o caraffa", prezzo: "2 mr", peso: 2 },
    { key: "campanella", prezzo: "1 mo", peso: 0.1 },
    { key: "candela", prezzo: "1 mr", peso: 0.1 },
    { key: "canestro", prezzo: "4 mr", peso: 1.5 },
    { key: "canna da pesca", prezzo: "1 mo", peso: 2 },
    { key: "cannocchiale", prezzo: "1000 mo", peso: 1 },
    { key: "carta (un foglio)", prezzo: "2 mr", peso: 0.1 },
    { key: "carrucola e paranco", prezzo: "1 mo", peso: 2.5 },
    { key: "catena (3 metri)", prezzo: "5 mo", peso: 5 },
    { key: "cera per sigillo", prezzo: "5 mr", peso: 0.1 },
    { key: "chiodo da rocciatore", prezzo: "1 mo", peso: 0.125 },
    { key: "clessidra", prezzo: "25 mo", peso: 0.5 },
    { key: "coperta", prezzo: "5 mo", peso: 1.5 },
    { key: "corda di canapa (15 metri)", prezzo: "1 mo", peso: 5 },
    { key: "corda di seta (15 metri)", prezzo: "10 mo", peso: 2.5 },
    { key: "cote per affilare", prezzo: "1 mo", peso: 0.5 },
    { key: "custodia per mappe o pergamene", prezzo: "1 mo", peso: 0.5 },
    { key: "custodia per quadrelli da balestra", prezzo: "1 mo", peso: 1 },
    { key: "fiala", prezzo: "1 mo", peso: 0.1 },
    { key: "fischietto da richiamo", prezzo: "5 mr", peso: 0.1 },
    { key: "bacchetta", prezzo: "10 mo", peso: 0.5 },
    { key: "bastone", prezzo: "5 mo", peso: 2 },
    { key: "cristallo", prezzo: "10 mo", peso: 0.5 },
    { key: "globo", prezzo: "10 mo", peso: 1.5 },
    { key: "verga", prezzo: "10 mo", peso: 1 },
    { key: "bacchetta in legno di tasso", prezzo: "10 mo", peso: 0.5 },
    { key: "bastone di legno", prezzo: "5 mo", peso: 2 },
    { key: "rametto di vischio", prezzo: "1 mo", peso: 0.1 },
    { key: "totem", prezzo: "1 mo", peso: 0.5 },
    { key: "forziere", prezzo: "5 mo", peso: 12.5 },
    { key: "fuoco dell'alchimista (ampolla)", prezzo: "50 mo", peso: 0.5 },
    { key: "gavetta", prezzo: "2 mo", peso: 0.5 },
    { key: "gessetto (1 pezzo)", prezzo: "1 mr", peso: 0.1 },
    { key: "giaciglio", prezzo: "1 mo", peso: 2.5 },
    { key: "inchiostro (boccetta da 30 grammi)", prezzo: "10 mo", peso: 0.1 },
    { key: "lanterna a lente sporgente", prezzo: "10 mo", peso: 1 },
    { key: "lanterna schermabile", prezzo: "5 mo", peso: 1 },
    { key: "lente d'ingrandimento", prezzo: "100 mo", peso: 0.5 },
    { key: "libro", prezzo: "25 mo", peso: 2.5 },
    { key: "libro degli incantesimi", prezzo: "50 mo", peso: 1.5 },
    { key: "manette", prezzo: "2 mo", peso: 1.5 },
    { key: "martello di demolizione", prezzo: "5 mo", peso: 5 },
    { key: "munizioni", prezzo: "—", peso: 0 }, // peso gestito per singoli item sotto
    { key: "aghi da cerbottana (50)", prezzo: "1 mo", peso: 0.5 },
    { key: "frecce (20)", prezzo: "1 mo", peso: 0.5 },
    { key: "proiettili da fionda (20)", prezzo: "4 rm", peso: 0.75 },
    { key: "quadrelli da balestra (20)", prezzo: "1 mo", peso: 0.75 },
    { key: "olio (ampolla)", prezzo: "1 mr", peso: 0.5 },
    { key: "otre", prezzo: "2 mr", peso: 2.5 },
    { key: "pennino", prezzo: "2 mr", peso: 0.1 },
    { key: "pergamena (un foglio)", prezzo: "1 mo", peso: 0.1 },
    { key: "piccone da minatore", prezzo: "2 mo", peso: 5 },
    { key: "piede di porco", prezzo: "2 mo", peso: 2.5 },
    { key: "pozione di guarigione", prezzo: "50 mo", peso: 0.25 },
    { key: "profumo (fiala)", prezzo: "5 mo", peso: 0.1 },
    { key: "rampino", prezzo: "2 mo", peso: 2 },
    { key: "razioni (1 giornata)", prezzo: "5 mo", peso: 1 },
    { key: "sacco", prezzo: "1 rm", peso: 0.25 },
    { key: "sapone", prezzo: "2 mr", peso: 0.25 },
    { key: "scala a pioli (3 metri)", prezzo: "1 mo", peso: 12.5 },
    { key: "secchio", prezzo: "5 mr", peso: 1.5 },
    { key: "serratura", prezzo: "10 mo", peso: 0.5 },
    { key: "sfere metalliche (sacchetto da 1.000)", prezzo: "1 mo", peso: 1 },
    { key: "simbolo sacro", prezzo: "5 mo", peso: 0.5 },
    { key: "emblema", prezzo: "5 mo", peso: 0.5 },
    { key: "reliquiario", prezzo: "5 mo", peso: 0.5 },
    { key: "specchio piccolo di metallo", prezzo: "5 mo", peso: 0.25 },
    { key: "spuntoni, ferro (10)", prezzo: "2,5 mo", peso: 1.5 },
    { key: "tenda per due persone", prezzo: "2 mo", peso: 10 },
    { key: "torcia", prezzo: "1 rm", peso: 0.5 },
    { key: "triboli (sacchetto da 20)", prezzo: "1 mo", peso: 1 },
    { key: "vanga o badile", prezzo: "2 mo", peso: 2.5 },
    { key: "vaso di ferro", prezzo: "1 mo", peso: 5 },
    { key: "veleno, base (fiala)", prezzo: "100 mo", peso: 0.1 },
    { key: "veste", prezzo: "1 mo", peso: 2 },
    { key: "zaino", prezzo: "2 mo", peso: 2.5 },
    
    // Armature
    { key: "imbottita", prezzo: "5 mo", peso: 4, ca: des => 11 + des, furtivita: "svantaggio", armatura: "leggera" },
    { key: "cuoio", prezzo: "10 mo", peso: 5, ca: des => 11 + des, armatura: "leggera" },
    { key: "cuoio borchiato", prezzo: "45 mo", peso: 6.5, ca: des => 12 + des, armatura: "leggera" },
    { key: "pelle", prezzo: "10 mo", peso: 6, ca: des => 12 + Math.min(des, 2), armatura: "media" },
    { key: "giaco di maglia", prezzo: "50 mo", peso: 10, ca: des => 13 + Math.min(des, 2), armatura: "media" },
    { key: "corazza di scaglie", prezzo: "50 mo", peso: 22.5, ca: des => 14 + Math.min(des, 2), furtivita: "svantaggio", armatura: "media" },
    { key: "corazza di piastre", prezzo: "400 mo", peso: 10, ca: des => 14 + Math.min(des, 2), armatura: "media" },
    { key: "mezza armatura", prezzo: "750 mo", peso: 20, ca: des => 15 + Math.min(des, 2), furtivita: "svantaggio", armatura: "media" },
    { key: "corazza ad anelli", prezzo: "30 mo", peso: 20, ca: () => 14, furtivita: "svantaggio", armatura: "pesante" },
    { key: "cotta di maglia", prezzo: "75 mo", peso: 27.5, ca: () => 16, forza: 13, furtivita: "svantaggio", armatura: "pesante" },
    { key: "corazza a strisce", prezzo: "200 mo", peso: 30, ca: () => 17, forza: 15, furtivita: "svantaggio", armatura: "pesante" },
    { key: "armatura completa", prezzo: "1500 mo", peso: 32.5, ca: () => 18, forza: 15, furtivita: "svantaggio", armatura: "pesante" },
    { key: "scudo", prezzo: "10 mo", peso: 3, ca: () => 2, armatura: "scudo" },

    // Armi da Mischia Semplici
    { key: "ascia", prezzo: "5 mo", peso: 1, danno: "1d6 taglienti", proprietà: "lancio (6/18), leggera", arma: "da mischia semplice" },
    { key: "bastone ferrato", prezzo: "2 mo", peso: 2, danno: "1d8 contundenti", proprietà: "versatile (1d10)", arma: "da mischia semplice" },
    { key: "falcetto", prezzo: "1 mo", peso: 1, danno: "1d4 taglienti", proprietà: "leggera", arma: "da mischia semplice" },
    { key: "giavellotto", prezzo: "1 mo", peso: 1, danno: "1d6 perforanti", proprietà: "lancio (6/18)", arma: "da mischia semplice" },
    { key: "lancia", prezzo: "1 mo", peso: 1.5, danno: "1d6 perforanti", proprietà: "lancio (6/18), versatile (1d8)", arma: "da mischia semplice" },
    { key: "martello leggero", prezzo: "2 mo", peso: 1, danno: "1d4 contundenti", proprietà: "lancio (6/18), leggera", arma: "da mischia semplice" },
    { key: "mazza", prezzo: "5 mo", peso: 2, danno: "1d6 contundenti", arma: "da mischia semplice" },
    { key: "pugnale", prezzo: "2 mo", peso: 0.5, danno: "1d4 perforanti", proprietà: "accurata, lancio (6/18), leggera", arma: "da mischia semplice" },
    { key: "randello", prezzo: "1 rm", peso: 1, danno: "1d4 contundenti", arma: "da mischia semplice" },
    { key: "randello pesante", prezzo: "2 mo", peso: 5, danno: "1d8 contundenti", proprietà: "due mani", arma: "da mischia semplice" },
    
    // Armi a Distanza Semplici
    { key: "arco corto", prezzo: "25 mo", peso: 1, danno: "1d6 perforanti", proprietà: "due mani, munizioni (24/96)", arma: "a distanza semplice" },
    { key: "balestra leggera", prezzo: "25 mo", peso: 2.5, danno: "1d8 perforanti", proprietà: "due mani, munizioni (24/96), ricarica", arma: "a distanza semplice" },
    { key: "dardo", prezzo: "5 mr", peso: 0.125, danno: "1d4 perforanti", proprietà: "accurata, lancio (6/18)", arma: "a distanza semplice" },
    { key: "fionda", prezzo: "1 mr", peso: 0, danno: "1d4 contundenti", proprietà: "munizioni (9/36)", arma: "a distanza semplice" },

    // Armi da Mischia da Guerra
    { key: "alabarda", prezzo: "20 mo", peso: 3, danno: "1d10 taglienti", proprietà: "due mani, pesante, portata", arma: "da mischia da guerra" },
    { key: "ascia bipenne", prezzo: "30 mo", peso: 3.5, danno: "1d12 taglienti", proprietà: "due mani, pesante", arma: "da mischia da guerra" },
    { key: "ascia da battaglia", prezzo: "10 mo", peso: 2, danno: "1d8 taglienti", proprietà: "versatile (1d10)", arma: "da mischia da guerra" },
    { key: "falcione", prezzo: "20 mo", peso: 3, danno: "1d10 taglienti", proprietà: "due mani, pesante, portata", arma: "da mischia da guerra" },
    { key: "frusta", prezzo: "2 mo", peso: 1.5, danno: "1d4 taglienti", proprietà: "accurata, portata", arma: "da mischia da guerra" },
    { key: "lancia da cavaliere", prezzo: "10 mo", peso: 3, danno: "1d12 perforanti", proprietà: "portata, speciale", arma: "da mischia da guerra" },
    { key: "maglio", prezzo: "10 mo", peso: 5, danno: "2d6 contundenti", proprietà: "due mani, pesante", arma: "da mischia da guerra" },
    { key: "martello da guerra", prezzo: "15 mo", peso: 1, danno: "1d8 contundenti", proprietà: "versatile (1d10)", arma: "da mischia da guerra" },
    { key: "mazzafrusto", prezzo: "10 mo", peso: 1, danno: "1d8 contundenti", proprietà: "", arma: "da mischia da guerra" },
    { key: "morning star", prezzo: "15 mo", peso: 2, danno: "1d8 perforanti", proprietà: "", arma: "da mischia da guerra" },
    { key: "picca", prezzo: "5 mo", peso: 9, danno: "1d10 perforanti", proprietà: "due mani, pesante, portata", arma: "da mischia da guerra" },
    { key: "piccone da guerra", prezzo: "5 mo", peso: 1, danno: "1d8 perforanti", proprietà: "", arma: "da mischia da guerra" },
    { key: "scimitarra", prezzo: "25 mo", peso: 1.5, danno: "1d6 taglienti", proprietà: "accurata, leggera", arma: "da mischia da guerra" },
    { key: "spada corta", prezzo: "10 mo", peso: 1, danno: "1d6 perforanti", proprietà: "accurata, leggera", arma: "da mischia da guerra" },
    { key: "spada lunga", prezzo: "15 mo", peso: 1.5, danno: "1d8 taglienti", proprietà: "versatile (1d10)", arma: "da mischia da guerra" },
    { key: "spadone", prezzo: "50 mo", peso: 3, danno: "2d6 taglienti", proprietà: "due mani, pesante", arma: "da mischia da guerra" },
    { key: "stocco", prezzo: "25 mo", peso: 1, danno: "1d8 perforanti", proprietà: "accurata", arma: "da mischia da guerra" },
    { key: "tridente", prezzo: "5 mo", peso: 2, danno: "1d6 perforanti", proprietà: "lancio (6/18), versatile (1d8)", arma: "da mischia da guerra" },

    // Armi a Distanza da Guerra
    { key: "arco lungo", prezzo: "50 mo", peso: 1, danno: "1d8 perforanti", proprietà: "due mani, munizioni (45/180)", arma: "a distanza da guerra" },
    { key: "balestra a mano", prezzo: "75 mo", peso: 1.5, danno: "1d6 perforanti", proprietà: "accurata, munizioni (9/36), ricarica", arma: "a distanza da guerra" },
    { key: "balestra pesante", prezzo: "50 mo", peso: 9, danno: "1d10 perforanti", proprietà: "due mani, munizioni (30/120), ricarica", arma: "a distanza da guerra" },
    { key: "cerbottana", prezzo: "10 mo", peso: 0.5, danno: "1d1 perforanti", proprietà: "munizioni (7,5/30), ricarica", arma: "a distanza da guerra" },
    { key: "rete", prezzo: "1 mo", peso: 1.5, danno: "-", proprietà: "lancio (1,5/4,5), speciale", arma: "a distanza da guerra" },

    // Armi da fuoco  
    { key: "archibugio", prezzo: "250 mo", peso: 4.5, danno: "1d12 perforanti", proprietà: "due mani, munizioni (distinta), ricarica", arma: "a distanza da guerra" },
    { key: "moschetto", prezzo: "500 mo", peso: 5, danno: "1d12 perforanti", proprietà: "due mani, munizioni, ricarica", arma: "a distanza da guerra" },
    { key: "pistola", prezzo: "250 mo", peso: 1.5, danno: "1d10 perforanti", proprietà: "munizioni, ricarica", arma: "a distanza da guerra" },
    { key: "pistola da palmo", prezzo: "100 mo", peso: 0.5, danno: "1d8 perforanti", proprietà: "nascosta, munizioni, ricarica", arma: "a distanza da guerra" },
    { key: "rivoltina", prezzo: "500 mo", peso: 1.5, danno: "1d10 perforanti", proprietà: "speciale, munizioni", arma: "a distanza da guerra" },
    { key: "schioppo", prezzo: "300 mo", peso: 9, danno: "2d8 perforanti", proprietà: "due mani, ricarica, munizioni", arma: "a distanza da guerra" }
  ],

  peso(param=''){
    // se è una stringa
    if(typeof param === 'string' && param){
      const oggetto = this.oggetti.find(d => param.toLocaleLowerCase().includes(d.key.toLocaleLowerCase()));
      return oggetto ? oggetto.peso : 0;

    // se è un array di stringhe
    }else if(Array.isArray(param) && param.length > 0 && param.every(p => typeof p === 'string')){
      return param.reduce((acc, key) => acc + this.peso(key), 0);
    }
    return 0;
  },
  
  danno(nomeArma =''){
    const arma = this.oggetti.find(d => nomeArma.toLocaleLowerCase().includes(d.key.toLocaleLowerCase()));
    if(!arma || !arma.arma) return {dadi: '', tipo: ''};
    const [dadi, tipo] = arma.danno.split(' ');
    return {dadi, tipo};
  },

};
  
class App {
  constructor() {
    window.app = this;
    this.init();
    Autocomplete.init();
    // Re-apply details state on window resize
    window.addEventListener('resize', () => this.applyDetails());
  }

  local = {
    get: async () => {
      const characterData = localStorage.getItem('character');
      if (characterData) {
        this.character = JSON.parse(characterData);
      }
    },
    set: () => {
      localStorage.setItem('character', JSON.stringify(this.character));
    },
    copy: () => {
      const data = JSON.stringify(this.character, null, 2);
      navigator.clipboard.writeText(data);
    },
    paste: () => {
      navigator.clipboard.readText()
        .then(text => {
          // deve contenere '{', '}', ']' e '['
          const requiredChars = ['{', '}', '[', ']', ':'];
          const hasRequiredChars = requiredChars.every(char => text.includes(char));
          if (!hasRequiredChars) {
            alert("Il contenuto degli appunti non sembra essere un JSON valido.");
            return;
          }
          this.character = JSON.parse(text);
          this.render();
        })
        .catch(err => console.error('Error pasting character:', err));
    }
  }

  // Autocomplete component (inspired by 'Autocomplete')
  async init() {
    this.character = this.initCharacter();
    await this.local.get();
    this.render();
  }

  initCharacter =_=> ({
    nome_personaggio: 'Grog Strongjaw',
    generali: [
      { key: 'background', value: 'Soldato', type: 'text' },
      { key: 'nome_giocatore', value: 'Travis', type: 'text' },
      { key: 'razza', value: 'Goliath', type: 'text' },
      { key: 'allineamento', value: 'Caotico Neutrale', type: 'text' },
      { key: 'punti_esperienza', value: 15000, type: 'number' },
    ],

    // colonna sinistra
    ispirazione: 1,
    punteggi: [
      { key: 'forza', value: 20, abilities: [
        { key: 'Tiro Salvezza', value: true }, 
        { key: 'Atletica', value: true }
      ]},
      { key: 'destrezza', value: 15, abilities: [
        { key: 'Tiro Salvezza', value: false }, 
        { key: 'Acrobatica', value: false }, 
        { key: 'Rapidità di Mano', value: false }, 
        { key: 'Furtività', value: false }
      ]},
      { key: 'costituzione', value: 18, abilities: [
        { key: 'Tiro Salvezza', value: true }
      ]},
      { key: 'intelligenza', value: 6, abilities: [
        { key: 'Tiro Salvezza', value: false }, 
        { key: 'Arcano', value: false }, 
        { key: 'Indagare', value: false }, 
        { key: 'Natura', value: false }, 
        { key: 'Religione', value: false }, 
        { key: 'Storia', value: false }
      ]},
      { key: 'saggezza', value: 12, abilities: [
        { key: 'Tiro Salvezza', value: false }, 
        { key: 'Addestrare Animali', value: true }, 
        { key: 'Intuizione', value: false }, 
        { key: 'Medicina', value: false }, 
        { key: 'Percezione', value: true }, 
        { key: 'Sopravvivenza', value: false }
      ]},
      { key: 'carisma', value: 13, abilities: [
        { key: 'Tiro Salvezza', value: false }, 
        { key: 'Inganno', value: false }, 
        { key: 'Intimidire', value: true }, 
        { key: 'Intrattenere', value: false }, 
        { key: 'Persuasione', value: false }
      ]},
    ],
    saggezza_passiva: 15,
    competenze:[
      {key:'linguaggi', value:'Comune e Gigante'},
      {key:'armi', value:'Tutte'},
      {key:'armature', value:'leggere e medie'},
      {key:'strumenti', value:'Giochi da tavolo'},
    ],
    
    // colonna centrale
    classe_armatura: 10,
    punti_ferita_attuali: 10,
    punti_ferita_temporanei: 10,
    ts_falliti: 2,
    ts_successi: 1,
    attacchi:['ascia bipenne', 'alabarda', 'lancia'],
    equipaggiamento: [
      {qta:3, value:'torcia'},
      {qta:1, value:'acciarino'},
      {qta:10, value:'razioni'},
    ],
    monete: [ 
      { key: 'rame', value: 5 },
      { key: 'argento', value: 10 },
      { key: 'electrum', value: 0 },
      { key: 'oro', value: 25 },
      { key: 'platino', value: 1 }
    ],

    // colonna destra
    personalita: [
      {key:'tratti_caratteriali', value:'Mi piace spaccare le cose. Sono diretto e onesto.'},
      {key:'ideali', value:'La gloria della battaglia è tutto ciò che conta.'},
      {key:'legami', value:'Proteggerò i miei amici, specialmente Pike.'},
      {key:'difetti', value:'Non penso mai prima di agire. Mai.'},
    ],
    privilegi:['barbaro', 'barbaro', 'stregone', 'barbaro', 'stregone']
  });
  character = this.initCharacter();

  handleChange(event) {
    const { name, value, type, checked } = event.target;
    // Supporta sia path con punti (es. "punteggi.0.value") sia il nuovo pattern con underscore
    // per i campi generali (es. "generali_3_value" => ["generali", 3, "value"]).
    const m = /^generali_(\d+)_value$/.exec(name);
    const keys = m ? ['generali', m[1], 'value'] : name.split('.');
    let current = this.character;

    for (let i = 0; i < keys.length - 1; i++) {
      if (!current[keys[i]]) {
        current[keys[i]] = isNaN(keys[i + 1]) ? {} : [];
      }
      current = current[keys[i]];
    }

    // Autocomplete required validation: se c'è un UL[autocomplete] con required e il valore non è tra le LI, blocca
    const inputEl = event.target;
    if (inputEl instanceof HTMLInputElement && inputEl.type === 'search') {
      const scope = inputEl.parentElement || document;
      const listEl = scope.querySelector(`ul[autocomplete="${CSS.escape(name)}"]`);
      if (listEl && listEl.hasAttribute('required')) {
        const options = Array.from(listEl.querySelectorAll('li')).map(li => (li.textContent || '').trim());
        const isValid = options.includes((value || '').trim());
        if (!isValid) {
          // revert UI to previous value and exit without modifying state
          try {
            // compute previous value without mutating
            let prevObj = this.character;
            for (let i = 0; i < keys.length - 1; i++) prevObj = prevObj[keys[i]];
            const prev = prevObj ? prevObj[keys[keys.length - 1]] : '';
            inputEl.value = (prev ?? '').toString();
          } catch {}
          return;
        }
      }
    }

    let finalValue = value;
    if (type === 'checkbox') {
      finalValue = checked;
    } else if (!isNaN(parseFloat(value)) && isFinite(value) && value.trim() !== '') {
      finalValue = parseFloat(value);
    }

    current[keys[keys.length - 1]] = finalValue;
    this.local.set();
    this.render();
    this.toast('Modificato');
  }

  /**
   * Rimuove un elemento da una lista del personaggio (es. attacchi, equipaggiamento, privilegi)
   * @param {keyof typeof this.character} listName - Nome della proprietà array dentro this.character
   * @param {number} index - Posizione dell'elemento da rimuovere
   * @returns {void}
   */
  deleteFromList(listName, index) {
    if (this.character[listName] && Array.isArray(this.character[listName])) {
      // rimuove l'elemento in posizione 'index'
      this.character[listName].splice(index, 1);
      // persiste e aggiorna la UI
      this.local.set();
      this.render();
      this.toast('Modificato');
    } else {
      console.error(`List ${listName} not found or not an array.`);
    }
  }

  /**
   * Imposta il numero di successi/fallimenti dei TS morte in base al checkbox cliccato
   * @param {'ts_successi'|'ts_falliti'} field
   * @param {1|2|3} index
   * @param {boolean} checked
   * @returns {void}
   */
  setDeathSave(field, index, checked) {
    // index è 1..3. Se spunto il 2°, valore=2; se lo deseleziono, valore=1
    const value = checked ? index : (index - 1);
    this.character[field] = value;
    this.local.set();
    this.render();
    this.toast('Modificato');
  }

  /**
   * Aggiunge un elemento a una lista del character.
   * Regole speciali:
   * - equipaggiamento: merge per nome (case-insensitive), incrementando la quantità
   * - attacchi: evita duplicati (case-insensitive)
   * @param {string} listName
   * @param {string|HTMLFormElement} payload - Valore semplice o form di submit
   * @param {SubmitEvent} [evt]
   * @returns {void}
   */
  addToList(listName, payload, evt) {
    // 1) Se proviene da un form, previene il submit di default
    if (evt?.preventDefault) evt.preventDefault();

    // 2) Helper per persistere e ri-renderizzare
    const commit = () => { this.local.set(); this.render(); };

    // Helper: dato un input, se ha UL required e valore non presente tra i LI, blocca
    const isInputValidPerAutocomplete = (inputEl) => {
      if (!(inputEl instanceof HTMLInputElement)) return true;
      if (inputEl.type !== 'search') return true;
      const name = inputEl.name;
      const listEl = document.querySelector(`ul[autocomplete][name="${CSS.escape(name)}"]`);
      if (!listEl) return true;
      if (!listEl.hasAttribute('required')) return true;
      const val = (inputEl.value || '').trim();
      const options = Array.from(listEl.querySelectorAll('li')).map(li => (li.textContent || '').trim());
      return options.includes(val);
    };

    // 3) Se la lista non esiste, inizializzala come array
    if (!Array.isArray(this.character[listName])) this.character[listName] = [];

    // 4) Helper interno: aggiunge/merga un oggetto di equipaggiamento
    //    - normalizza il nome (trim + lowercase)
    //    - se esiste, somma la quantità; altrimenti pusha un nuovo oggetto {qta, value}
    const addEquip = (name, qtaToAdd = 1) => {
      const key = (name || '').trim().toLowerCase();
      if (!key) return false;
      const list = this.character.equipaggiamento;
      const existing = list.find(it => (it.value || '').trim().toLowerCase() === key);
      if (existing) {
        existing.qta = (parseFloat(existing.qta) || 0) + (parseFloat(qtaToAdd) || 0);
      } else {
        list.push({ qta: (parseFloat(qtaToAdd) || 1), value: name.trim() });
      }
      return true;
    };

    // 5) Gestione invio FORM (es. equipaggiamento)
    if (payload?.tagName === 'FORM') {
      const form = payload;
      const qtyInput = form.querySelector('input[type="number"]');
      const nameInput = form.querySelector('input[type="search"], input[type="text"]');
      const qta = parseFloat(qtyInput?.value) || 1;
      const name = (nameInput?.value || '').trim();

      if (listName === 'equipaggiamento') {
        // equipaggiamento: se il nome è vuoto, non aggiunge
        if (!name) return;
        if (!isInputValidPerAutocomplete(nameInput)) return; // blocca se non corrisponde alle opzioni richieste
        addEquip(name, qta);
        try { form.reset(); } catch {}
        return commit();
      }

      // per liste diverse: pusha il valore se non vuoto
      if (!name) return;
      if (!isInputValidPerAutocomplete(nameInput)) return; // blocca se non valido rispetto all'autocomplete
      if (listName === 'attacchi') {
        // evita duplicati: confronta case-insensitive
        const exists = (this.character.attacchi || []).some(a => (a || '').toString().trim().toLowerCase() === name.toLowerCase());
        if (!exists) this.character.attacchi.push(name);
        try { form.reset(); } catch {}
        return commit();
      }
      this.character[listName].push(name);
      try { form.reset(); } catch {}
      return commit();
    }

    // 6) Gestione valore semplice (string) da input text/search
    const val = (typeof payload === 'string') ? payload.trim() : '';
    if (!val) return;
    // Se proviene da un input "add", tenta di validare contro il relativo UL required
    let sourceInput = null;
    try {
      sourceInput = document.querySelector(`input.add[name="${CSS.escape(listName)}"]`) || document.querySelector(`input.add#${CSS.escape(listName)}`);
    } catch {}
    if (sourceInput) {
      const listEl = document.querySelector(`ul[autocomplete][name="${CSS.escape(sourceInput.name)}"]`);
      if (listEl && listEl.hasAttribute('required')) {
        const options = Array.from(listEl.querySelectorAll('li')).map(li => (li.textContent || '').trim());
        if (!options.includes(val)) return; // blocca aggiunta
      }
    }
    if (listName === 'equipaggiamento') { addEquip(val, 1); return commit(); }
    if (listName === 'privilegi') {
      const list = Array.isArray(this.character.privilegi) ? this.character.privilegi : (this.character.privilegi = []);
      const text = val;
      const cls = text.split(' ')[0]?.toLowerCase();
      if (!cls) return;
      const dupIndex = list.findIndex((it) => (it || '').toString().trim().toLowerCase().startsWith(cls + ' '));
      if (dupIndex >= 0) {
        const existing = (list[dupIndex] || '').toString().trim().toLowerCase();
        const want = text.toLowerCase();
        if (existing !== want) {
          // stessa classe ma sottoclasse diversa: annulla inserimento e pulisci input di aggiunta
          const addInput = document.querySelector('input#privilegi.add, input[name="privilegi"].add');
          if (addInput) addInput.value = '';
          return; // no commit
        }
        // stessa coppia: consenti inserimento (duplice intenzionale)
        list.push(text);
      } else {
        list.push(text); // classe diversa: inserisci
      }
      return commit();
    }
    if (listName === 'attacchi') {
      // evita duplicati: confronta case-insensitive
      const exists = (this.character.attacchi || []).some(a => (a || '').toString().trim().toLowerCase() === val.toLowerCase());
      if (!exists) this.character.attacchi.push(val);
      return commit();
    }
    // default: aggiunge in coda
    this.character[listName].push(val);
    return commit();
  }

  //head
  /**
   * Aggrega le classi a partire dall'array 'privilegi'.
   * Un privilegio può essere solo la classe (es. "barbaro") oppure "classe sottoclasse" (es. "barbaro cammino del berserker").
   * Se 'privilegi' è omesso o vuoto, usa this.character.privilegi.
   * @param {string[]=} privilegi
   * @returns {{classe:string, sottoclasse:string, livello:number}[]}
   */
  classi(privilegi = ['']) {
    const result = [{ classe: '', sottoclasse: '', livello: 0 }];
    const source = (Array.isArray(privilegi) && privilegi.length)
      ? privilegi
      : this.character.privilegi;
    source.forEach(val => {
      const first = String(val || '').split(' ')[0].
        replace(/^[a-z]/, c => c.toUpperCase()); // la prima lettera è maiuscola
      const second = String(val || '').split(' ').slice(1).join(' ');
      if (!first) return;
      const found = result.find(c => c.classe === first);
      if (found) found.livello++;
      else       result.push({ classe: first, sottoclasse: second, livello: 1 });
    });
    return result .filter(c => c.classe && c.livello);
  }
  //!colonna sinistra
  /**
   * Calcola il modificatore di caratteristica
   * @param {number} score
   * @returns {number}
   */
  mod =(score)=> Math.floor((score - 10) / 2);
  /**
   * Calcola il bonus per un'abilità in funzione della caratteristica e della competenza
   * @param {number} punteggioCaratteristica
   * @param {boolean} checkAbilita
   * @returns {string|number} Valore con segno quando positivo
   */
  abilityMod(punteggioCaratteristica, checkAbilita){
    let result = this.mod(punteggioCaratteristica);
    if(checkAbilita){
      result += this.BC();
    }
    return result>0 ?`+${result}` :result;
  }
  /**
   * Calcola il livello del personaggio in base ai PE
   * @param {string[]=} privilegi
   * @returns {number}
   */
  L(privilegi) {
    const pe = this.character.generali.find(g => g.key === 'punti_esperienza')?.value;
    if (typeof pe !== 'number') return 404;

    // Soglie dei PE per ogni livello
    const thresholds = [
      0,      // livello 1
      300,    // 2
      900,    // 3
      2700,   // 4
      6500,   // 5
      14000,  // 6
      23000,  // 7
      34000,  // 8
      48000,  // 9
      64000,  // 10
      85000,  // 11
      100000, // 12
      120000, // 13
      140000, // 14
      165000, // 15
      195000, // 16
      225000, // 17
      265000, // 18
      305000, // 19
      355000  // 20
    ];

    // Trova ultimo livello in cui pe >= soglia
    for (let lvl = thresholds.length; lvl > 0; lvl--) {
      if (pe >= thresholds[lvl - 1]) {
        return lvl;
      }
    }
    return 1; // fallback (non dovrebbe mai arrivarci)
  }
  /**
   * Bonus di Competenza derivato dal livello corrente
   * @returns {number}
   */
  BC() {
    const livello = this.L(this.character.privilegi); // chiama la funzione liv()
    if (typeof livello !== 'number' || livello < 1) return 404;

    return 2 + Math.floor((livello - 1) / 4);
  }

  /**
   * Utility:
   * - Se chiamata come renderPrivilegi(arr): raggruppa per classe base e ritorna tutti i privilegi di classe per ciascun livello raggiunto (conteggio occorrenze sottoclasse).
   * - Se chiamata come renderPrivilegi(arr, voce, i): ritorna i privilegi dal livello 1 fino al livello cumulativo della classe alla posizione i.
   * @param {string[]} [characterPrivilegi]
   * @param {string} [voce]
   * @param {number} [voceIndex]
   * @returns {object[]|''}
   */
  renderPrivilegi(characterPrivilegi = [], voce='', voceIndex=0) {
    // Modalità gruppo: solo array passato, nessuna voce specifica
    if (!voce && (voceIndex === undefined || voceIndex === null)) {
      const levelsByClass = {};
      (characterPrivilegi || []).forEach(v => {
        const cls = String(v || '').split(' ')[0].trim().toLowerCase();
        if (!cls) return;
        levelsByClass[cls] = (levelsByClass[cls] || 0) + 1;
      });
      const out = [];
      Object.entries(levelsByClass).forEach(([cls, cnt]) => {
        for (let L = 1; L <= cnt; L++) {
          const base = DND.classi.find(p => p.class === cls && p.level === L);
          if (base) out.push(base);
        }
      });
      return out;
    }

    const parts = String(voce || '').split(' ');
    const classe = parts.shift() || '';
    const sottoclasse = parts.join(' ') || '';
    // normalizzazione case-insensitive
    const classeKey = classe.trim().toLowerCase();
    const sottoclasseKey = sottoclasse.trim().toLowerCase() || undefined;
    // livello cumulativo: conta le occorrenze della classe fino a voceIndex (incluso)
    const livelloCount = (characterPrivilegi || [])
      .slice(0, Math.max(0, (voceIndex ?? 0) + 1))
      .reduce((acc, v) => {
        const first = String(v || '').split(' ')[0].trim().toLowerCase();
        return acc + (first === classeKey ? 1 : 0);
      }, 0);
    const livello = livelloCount > 0 ? livelloCount : 1;

    // Recupera l'elenco dei privilegi per livelli 1..livello,
    // provando prima la sottoclasse tramite getPrivilegio; se assente o nullo,
    // fallback al privilegio di classe base (DND.classi)
    const lista = Array.from({ length: livello }, (_, k) => {
        const L = k + 1;
        const fromMethod = DND.getPrivilegio(classeKey, sottoclasseKey, L);
        if (fromMethod) return fromMethod;
        // se non c'è sottoclasse o non trovato, usa il base
        return DND.classi.find(p => p.class === classeKey && p.level === L) || null;
      })
      .filter(Boolean);
    if (!lista.length) return '';
    return lista;
  }

  //!COLONNA CENTRALE
  /**
   * Iniziativa = modificatore di Destrezza, formattato con segno se positivo
   * @returns {string|number}
   */
  iniziativa(){
    const destrezza = this.character.punteggi.find(p => p.key === 'destrezza');
    if (!destrezza) return 404;
    const value =this.mod(destrezza.value);
    return value>0?`+${value}`:value;
  }

  /**
   * Ritorna l'array velocità per la razza del personaggio
   * @returns {{key:string, value:number}[]|404}
   */
  velocita() {
    const razzaPersonaggio = String(this.character.generali.find(g => g.key === 'razza')?.value || '').trim().toLowerCase();
    if (!razzaPersonaggio) return [];
    const lista = Array.isArray(DND.sottorazze) ? DND.sottorazze : [];
    const razza = lista.find(r => {
      const n = String(r?.nome || '').trim().toLowerCase();
      if (!n) return false;
      return n === razzaPersonaggio || n.includes(razzaPersonaggio) || razzaPersonaggio.includes(n);
    });
    if (!razza) return [];
    return Array.isArray(razza.velocita) ? razza.velocita : [];
  }

  /**
   * Dato il nome di una classe, restituisce il suo dado vita (X in dX).
   * Se la classe non è riconosciuta, usa 6 come default (d6).
   * @param {string} nomeClasse
   * @returns {number}
   */
  dado_vita(nomeClasse) {
    const dadiVita = {
      'barbaro': 12,
      'guerriero': 10,
      'paladino': 10,
      'ranger': 10,
      'chierico': 8,
      'druido': 8,
      'monaco': 8,
      'ladro': 8,
      'bardo': 8,
      'stregone': 6,
      'mago': 6,
    };
    return dadiVita[nomeClasse.toLowerCase()] || 6; // Ritorna 6 come default
  }
  /**
   * Restituisce i dadi vita combinati per il personaggio.
   * Output: array di oggetti { livello: n, dado: X } per formattare "n dX".
   * @returns {{livello:number, dado:number}[]}
   */
  dadi_vita() {
    const privilegi = this.character.privilegi;
    const result = this.classi(privilegi).map(c => ({
      livello: c.livello,
      dado: this.dado_vita(c.classe),
    }));
    return result.filter(r => r.dado !== 0 && r.livello !== 0);
  }

  /**
   * Calcola i PF massimi in base ai dadi vita per livello e al modificatore di Costituzione
   * @returns {number}
   */
  puntiFeritaMassimi() {
    const costituzione = this.character.punteggi.find(p => p.key === 'costituzione').value;
    const conMod = this.mod(costituzione);
    let pfTotali = 0;

    const a = this.character.privilegi;
    a.forEach((nomeClasse, index) => {
      const dadoVita = this.dado_vita(nomeClasse);

      if (index === 0) {
        // 1° livello: Massimo del dado vita + modificatore di Costituzione
        pfTotali += dadoVita + conMod;
      } else {
        // Livelli successivi: Media del dado vita + modificatore di Costituzione
        const mediaDadoVita = (dadoVita / 2) + 1;
        pfTotali += mediaDadoVita + conMod;
      }
    });

    return pfTotali;
  }

  /**
   * Calcola il bonus all'attacco per un'arma, applicando competenza e caratteristica corretta
   * @param {string} [nomeArma]
   * @returns {string} Formattato con segno, oppure '—' se non calcolabile
   */
  bonusAttacco(nomeArma =''){
    const arma = DND.oggetti.find(d => String(nomeArma || '').toLowerCase().trim().includes(String(d.key || '').toLowerCase().trim()));
    const puntiForza =this.character.punteggi.find(p => p.key === 'forza');  
    const puntiDestrezza =this.character.punteggi.find(p => p.key === 'destrezza');
    if(!arma || !puntiForza || !puntiDestrezza) return '—';

    // Ranged weapons use Dexterity; otherwise apply finesse logic
    const isRanged = (arma.arma || '').includes('a distanza');
    const hasFinesse = String(arma.proprietà || '').includes('accurata');
    let abilitaBase = isRanged
      ? puntiDestrezza.value
      : (hasFinesse && puntiDestrezza.value > puntiForza.value
          ? puntiDestrezza.value
          : puntiForza.value);
    const result =(_=>{ 
      const modificatore =this.mod(abilitaBase) + this.BC();
      return modificatore >=0 ? `+${modificatore}` : modificatore.toString();
    })()
    return result;
  }

  /**
   * Calcola il danno dell'arma aggiungendo il modificatore caratteristica, es. "d8+3 tagliente"
   * @param {string} nomeArma
   * @returns {string} Stringa danno oppure '—' se non calcolabile
   */
  bonusDanno(nomeArma){
    const arma = DND.oggetti.find(d => String(nomeArma || '').toLowerCase().trim().includes(String(d.key || '').toLowerCase().trim()));
    const puntiForza =this.character.punteggi.find(p => p.key === 'forza');  
    const puntiDestrezza =this.character.punteggi.find(p => p.key === 'destrezza');
    if(!arma || !puntiForza || !puntiDestrezza) return '—';

    // Ranged weapons use Dexterity; otherwise apply finesse logic
    const isRanged = (arma.arma || '').includes('a distanza');
    const hasFinesse = String(arma.proprietà || '').includes('accurata');
    let abilitaBase = isRanged
      ? puntiDestrezza.value
      : (hasFinesse && puntiDestrezza.value > puntiForza.value
          ? puntiDestrezza.value
          : puntiForza.value);
    let mod = this.mod(abilitaBase)
    mod =mod>0  ?`+${mod}`  :mod==0 ?''  :mod;
    
    let [dadi, tipo] = arma.danno.split(' ');
    if(dadi.startsWith('1')) dadi = dadi.slice(1);// se dadi comincia con 1, rimuovilo
    return  dadi ? `${dadi}${mod} ${tipo}` : '—'; 
  }

  // calcola il peso attuale (tenendo conto della quantità di ogni item)
  /**
   * Calcola il peso totale trasportato
   * @returns {number} peso totale (kg)
   */
  
  // calcola il peso attuale e massimo
  trasporto(){
    // peso attuale
    const att =this.character.equipaggiamento
      .reduce((acc, e) => {
        const q = Number(e.qta) || 1;
        return acc + q * DND.peso(e.value);
      }, 0)
    // massimo peso trasportabile
    const max =this.character.punteggi
      .find(p => p.key =='forza').value *7.5 ||0;
    return att +' / '+ max
  }

  //COLONNA DESTRA
  /**
   * Mappa `this.character.privilegi` in oggetti con livello progressivo e privilegi risolti
   * @returns {{name:string, privileges:PrivilegioItem[], level:number, srcIndex?:number}[]}
   */
  privilegiMappati(){
    const result =[{ name: '', privileges: [{ privilege: '', description: '', level: 0 }], level: 0, srcIndex: 0 }].filter(r => r.name);

    // 1) Privilegi di Razza (pattern richiesto)
    try {
      const characterRace = (this.character.generali || []).find(g => g.key === 'razza')?.value;
      const allRaces = (_=> DND.sottorazze)();
      const match = allRaces?.find(race => race.nome.toLowerCase().includes(characterRace?.toLowerCase()));
      if (!characterRace || !allRaces || !match?.privilegi?.length) {
        // no push
      } else {
        result.push({
          name: 'Razza',
          privileges: match.privilegi.map(p => ({ privilege: p.name, description: p.description })),
          level: 0,
        });
      }
    } catch {}

    // 2) Privilegi di Background (stesso pattern)
    try {
      const characterBackground = (this.character.generali || []).find(g => g.key === 'background')?.value;
      const match = (DND.background || []).find(x => String(x.name || '').toLowerCase().includes(String(characterBackground || '').toLowerCase()));
      if (!characterBackground || !match?.privilegi?.length) {
        // no push
      } else {
        result.push({
          name: 'Background',
          privileges: match.privilegi.map(p => ({ privilege: p.name, description: p.description })),
          level: 0,
        });
      }
    } catch {}

    // 3) Privilegi di Classe
    const contatori = new Map();
    const classEntries = (this.character.privilegi || []).map((p, srcIndex) => {
      const raw = String(p || '');
      const rawLower = raw.toLowerCase();
      const [classe, ...rest] = raw.split(' ');
      const sottoclasse = rest.join(' ');
      const classeKey = String(classe || '').toLowerCase();
      const sottoclasseKey = String(sottoclasse || '').toLowerCase();
      const count = (contatori.get(rawLower) || 0) + 1; // case-insensitive counter
      contatori.set(rawLower, count);
      const privileges = DND.getPrivilegi(classeKey, sottoclasseKey, count);
      const name = [classe, sottoclasse].filter(Boolean).join(' ');
      return { name, privileges, level: count, srcIndex };
    });

    return result.concat(classEntries);
  }

  // Stato di apertura delle sezioni (<details>)
  details = [true, true, true, true, true, true, true];

  // Applica lo stato dei <details> e gestisce il comportamento responsive
  applyDetails(){
    const wide = window.innerWidth > 500;
    const nodes = Array.from(document.querySelectorAll('section > details'));
    if (!nodes.length) return;
    // Allinea la lunghezza dell'array stato se necessario
    if (!Array.isArray(this.details) || this.details.length !== nodes.length) {
      this.details = nodes.map(() => true);
    }
    nodes.forEach((el, i) => {
      // Imposta apertura in base alla larghezza schermo
      el.open = wide ? true : !!this.details[i];
      // Rimuovi eventuale handler precedente e riaggancia
      if (el._appHandler) el.removeEventListener('toggle', el._appHandler);
      const handler = () => {
        // Aggiorna lo stato solo su schermi piccoli; su larghe resta sempre aperto
        if (!wide) this.details[i] = el.open;
      };
      el._appHandler = handler;
      el.addEventListener('toggle', handler);
    });
  }
  
  /**
   * Gestisce le modifiche degli input del form (binding by name path)
   * @param {Event & { target: HTMLInputElement }} event
   * @returns {void}
   */
  handleChange(event){
    const { name, value, type, checked } = event.target;
    // Supporta path con punti e il nuovo pattern generali_#_value
    const m = /^generali_(\d+)_value$/.exec(name);
    const keys = m ? ['generali', m[1], 'value'] : name.split('.');

    let current = this.character;
    for (let i = 0; i < keys.length - 1; i++) {
      if (!current[keys[i]]) {
        current[keys[i]] = isNaN(keys[i+1]) ? {} : [];
      }
      current = current[keys[i]];
    }

    // Se l'utente svuota un attacco o la descrizione di un equipaggiamento, ripristina il valore precedente
    const lastKey = keys[keys.length - 1];
    const prevBefore = current[lastKey];
    const isAttack = keys[0] === 'attacchi';
    const isEquipValue = keys[0] === 'equipaggiamento' && lastKey === 'value';
    const typedText = (typeof value === 'string') ? value.trim() : value;
    if ((isAttack || isEquipValue) && (typedText === '' || typedText === undefined || typedText === null)) {
      try { event.target.value = (prevBefore ?? ''); } catch {}
      return; // non aggiornare lo stato se vuoto
    }

    // Normalizzazione e coercizione numerica robusta (gestisce anche virgola come separatore decimale)
    const coerceNumber = (v) => {
      if (typeof v !== 'string') return v;
      const s = v.trim().replace(',', '.');
      if (s === '') return v;
      const n = Number(s);
      return Number.isFinite(n) ? n : v;
    };

    let finalValue = value;
    if (type === 'checkbox') {
      finalValue = checked;
    } else if (type === 'number') {
      const s = String(value).trim().replace(',', '.');
      const n = Number(s);
      finalValue = Number.isFinite(n) ? n : 0;
    } else if (typeof value === 'string') {
      finalValue = coerceNumber(value);
    }

    // Regole speciali per privilegi: unicità sottoclasse per classe e rimozione su vuoto
    if (keys[0] === 'privilegi') {
      const idx = Number(keys[1]);
      const list = Array.isArray(this.character.privilegi) ? this.character.privilegi : (this.character.privilegi = []);
      const text = String(finalValue ?? '').trim();
      const inputEl = event.target;
      const prevValue = (!Number.isNaN(idx) && idx >= 0 && idx < list.length) ? (list[idx] || '') : '';
      // Se vuoto: elimina l'item e aggiorna
      if (!text) {
        if (!Number.isNaN(idx)) {
          list.splice(idx, 1);
          this.local.set();
          this.render();
          this.toast('Modificato');
          return;
        }
      } else {
        // Estrai la classe (prima parola) e applica regola:
        // - Se esiste già UNA classe uguale con SOTTOCLASSE diversa -> ANNULLA
        // - Se esiste già la stessa coppia classe+sottoclasse -> CONSENTI
        const cls = text.split(' ')[0]?.toLowerCase();
        if (cls) {
          const dupIndex = list.findIndex((it, i) => i !== idx && (it || '').toString().trim().toLowerCase().startsWith(cls + ' '));
          if (dupIndex >= 0) {
            const existing = (list[dupIndex] || '').toString().trim().toLowerCase();
            const want = text.toLowerCase();
            if (existing !== want) {
              // stessa classe ma sottoclasse diversa: annulla e ripristina il valore precedente
              if (inputEl) inputEl.value = prevValue;
              return;
            }
            // stessa classe e stessa sottoclasse: permetti
          }
        }
        // Imposta il valore (se idx non è valido, aggiungi in coda)
        if (!Number.isNaN(idx) && idx >= 0 && idx < list.length) {
          list[idx] = text;
        } else {
          list.push(text);
        }
      }
      this.local.set();
      this.render();
      this.toast('Modificato');
      return;
    }

    current[keys[keys.length - 1]] = finalValue;

    this.local.set();
    this.render();
    this.toast('Modificato');
  }

  toast(message) {
    const toast = document.getElementById('toast');
    if (toast) {
      toast.textContent = message;
      toast.classList.remove('hide');
      setTimeout(() => {
        toast.classList.add('hide');
      }, 2000);
    }
  }

  render() {
    const c = this.character;
    const sagg_passiva = () => {
      const sagg = c.punteggi.find(p => p.key === 'saggezza').value;
      return 10 + this.mod(sagg);
    };
    
    document.title = `Scheda di ${c.nome_personaggio}`;
    document.body.innerHTML = `
      <article>
        <header>
          <div class="score">
            <input value="${c.nome_personaggio}" onchange="app.handleChange(event)" name="nome_personaggio" id="nome_personaggio" type="text">
            <label for="nome_personaggio">Nome Personaggio</label>
          </div>

          <div style="display: flex; flex-wrap: wrap; justify-content: space-around; gap: 5px;">
            <div class="score">
              <div class="input">${this.classi(c.privilegi).map(c=>`${c.classe} ${c.livello}`).join(', ') ||'-'}</div>
              <label for="classe">Classe</label>
            </div>
            <div class="score">
              <div class="input">${this.L(c.privilegi) || '-'}</div>
              <label for="livello">Livello</label>
            </div>
            ${c.generali.map((g, i) => g.key ==='allineamento' ?`
              <div class="score">
                <select onchange="app.handleChange(event)" name="generali_${i}_value" id="${g.key}">
                  ${['Caotico buono','Caotico neutrale','Caotico malvagio','Neutrale buono','Neutrale','Neutrale malvagio','Legale buono','Legale neutrale','Legale malvagio'].map(a=>`
                    <option ${g.value===a?'selected':''} value="${a}">${a}</option>
                  `).join('')}
                </select>
                <label for="${g.key}">${g.key.replace(/_/g, ' ')}</label>
              </div>

            `:g.key === 'background'?`
              <div class="score">
                <select onchange="app.handleChange(event)" name="generali_${i}_value" id="${g.key}">
                  ${DND.background.map(b=>{ const a=b.name; const L=a.charAt(0).toUpperCase()+a.slice(1); return `<option ${((g.value||'').toLowerCase()===a.toLowerCase())?'selected':''} value="${L}">${L}</option>`; }).join('')}
                </select>
                <label for="${g.key}">${g.key.replace(/_/g, ' ')}</label>
              </div>

            `:g.key === 'razza'?`
              <div class="score">
                <input
                  value="${g.value}"
                  onchange="app.handleChange(event)"
                  name="generali_${i}_value"
                  id="${g.key}"
                  type="search"
                >
                <ul autocomplete="generali_${i}_value">
                  ${DND.sottorazze.map(r=>`
                    <li>${r.nome.charAt(0).toUpperCase()+r.nome.slice(1)}</li>
                  `).join('')}
                </ul>
                <label for="${g.key}">${g.key.replace(/_/g, ' ')}</label>
              </div>
            
            `/*DEFAULT*/:`
              <div class="score">
                <input value="${g.value}" onchange="app.handleChange(event)" name="generali_${i}_value" id="${g.key}" type="${g.key==='ispirazione' ? 'number' : g.type}" ${g.key==='ispirazione' ? 'inputmode=\"numeric\" step=\"1\" min=\"0\"' : ''}>
                <label for="${g.key}">${g.key.replace(/_/g, ' ')}</label>
              </div>
            `).join('')}
          </div>
        </header>

        <!--SINISTRA-->
        <section>
          <details open>
            <summary>Punteggi</summary>
            <main style="display: flex; flex-direction: column; gap: 10px;">
              <div class="mono">
                <label for="ispirazione">Ispirazione:</label> 
                <input value="${c.ispirazione}" onchange="app.handleChange(event)" 
                       name="ispirazione" id="ispirazione" type="number" inputmode="numeric" step="1" min="0">
              </div>
              <div class="mono">
                <label>Bonus Competenza:</label> 
                <b>+${this.BC()}</b>
              </div>
              ${c.punteggi.map((p, i) => `
                <div style="display:grid; grid-template-columns: auto 1fr;">
                  <div class="punteggi">
                    <label for="${p.key}">${p.key}</label> 
                    <label for="${p.key}">${this.mod(p.value)>0?`+${this.mod(p.value)}`: this.mod(p.value)}</label>
                    <input value="${p.value}" onchange="app.handleChange(event)" name="punteggi.${i}.value" id="${p.key}" type="text" max="25">
                  </div>
                  <ul>
                    ${p.abilities.map((a, j) => `
                      <li style="display: grid; grid-template-columns: auto 1fr; align-items: center;">
                        <div>
                          <input ${a.value ? 'checked' : ''} type="checkbox" id="${p.key}_${a.key}" name="punteggi.${i}.abilities.${j}.value" onchange="app.handleChange(event)"> 
                          <b style="padding-right: 5px;">${this.abilityMod(p.value, a.value)}</b>
                        </div>
                        <label for="${p.key}_${a.key}">${a.key}</label>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              `).join('')}
              <div class="mono"><i>Saggezza Passiva (Percezione):</i> <b>${sagg_passiva()}</b></div>
            </main>
          </details>

          <details open>
            <summary>Competenze e Linguaggi</summary>
            <main>
              <div style="display:grid; grid-template-columns: auto 1fr; gap: 5px;">
                ${c.competenze.map((c, i) => `
                  <label for="${c.key}">${c.key}:</label>
                  <textarea onchange="app.handleChange(event)" name="competenze.${i}.value" id="${c.key}">${c.value}</textarea>
                `).join('')}
              </div>
            </main>
          </details>
        </section>

        <!--CENTRO-->
        <section>
          <details open>
            <summary>Combattimento</summary>
            <main>
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px">
                <div class="score">
                  <label for="ca">Classe armatura</label>
                  <input value="${this.character.classe_armatura}" onchange="app.handleChange(event)" name="ca" id="ca" type="number">
                </div>
                <div class="score">
                  <label>Iniziativa</label>
                  <div class="input">${this.iniziativa()}</div>
                </div>
                <div class="score">
                  <label>Velocità</label>
                  ${this.velocita() .filter(v=>v.value) .map(v=>`
                    <span>${v.key.replace(/\b\w/g, l => l.toUpperCase())}: <b>${v.value}m</b></span>
                  `).join('')}
                </div>
              </div>

              <label>Punti Ferita</label>
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                <div class="score">
                  <label for="pfm">Massimi</label>
                  <div class="input">${this.puntiFeritaMassimi()}</div>
                </div>
                <div class="score">
                  <label for="pfa">Attuali</label>
                  <input value="${c.punti_ferita_attuali}" onchange="app.handleChange(event)" name="punti_ferita_attuali" id="pfa" type="number">
                </div>
                <div class="score">
                  <label for="pft">Temporanei</label>
                  <input value="${c.punti_ferita_temporanei}" onchange="app.handleChange(event)" name="punti_ferita_temporanei" id="pft" type="number">
                </div>
              </div>

              <div style="display:grid; grid-template-columns: 1fr 1fr; justify-items: center; gap: 5px;">
                <div class="score">
                  <label>Dadi Vita</label>
                  <div class="input">${this.dadi_vita().map(dv=>`${dv.livello}d${dv.dado}`).join(', ') ||'-'}</div>
                </div>
                <div class="score">
                  <label>Tiri Salvezza</label>
                  <div style="display:grid; grid-template-columns: 1fr auto auto auto;">
                    <label>Successi</label>
                    <input type="checkbox" ${c.ts_successi > 0 ? 'checked' : ''} onclick="app.setDeathSave('ts_successi', 1, this.checked)">
                    <input type="checkbox" ${c.ts_successi > 1 ? 'checked' : ''} onclick="app.setDeathSave('ts_successi', 2, this.checked)">
                    <input type="checkbox" ${c.ts_successi > 2 ? 'checked' : ''} onclick="app.setDeathSave('ts_successi', 3, this.checked)">
                    <label>Falliti</label>
                    <input type="checkbox" ${c.ts_falliti > 0 ? 'checked' : ''} onclick="app.setDeathSave('ts_falliti', 1, this.checked)">
                    <input type="checkbox" ${c.ts_falliti > 1 ? 'checked' : ''} onclick="app.setDeathSave('ts_falliti', 2, this.checked)">
                    <input type="checkbox" ${c.ts_falliti > 2 ? 'checked' : ''} onclick="app.setDeathSave('ts_falliti', 3, this.checked)">
                  </div>
                </div>
              </div>
            </main>
          </details>

          <details open>
            <summary>Attacchi e Incantesimi</summary>
            <main>
              <form onsubmit="app.addToList('attacchi', this)" class="row">
                <button type="submit" class="add" aria-label="Aggiungi attacco"><span class="material-symbols-outlined">add</span></button>
                <input name="attacchi" id="attacchi" type="search" placeholder="Aggiungi attacco" class="add">
                <ul autocomplete="attacchi">
                  ${DND.oggetti.filter(d=>d.arma).map(arma=>`
                    <li>${arma.key.charAt(0).toUpperCase()+arma.key.slice(1)}</li>
                  `).join('')}
                </ul>
              </form>
              <div style="display:grid; grid-template-columns: auto 100px auto 1fr; align-items: center; gap: 5px; text-align: center;">
                <i></i><b>Nome</b> <b>Attacco</b> <b>Danno</b>
                ${c.attacchi.map((attacco, i) => `
                  <button class="delete" onclick="app.deleteFromList('attacchi', ${i})"><span class="material-symbols-outlined">close</span></button>
                  <div style="position: relative; display: inline-block;">
                    <input value="${attacco}" type="search" id="attacchi.${i}" name="attacchi.${i}" onchange="app.handleChange(event)">
                    <ul autocomplete="attacchi.${i}">
                      ${DND.oggetti.filter(d=>d.arma).map(arma=>`
                        <li>${arma.key.charAt(0).toUpperCase()+arma.key.slice(1)}</li>
                      `).join('')}
                    </ul>
                  </div>
                  <label for="${attacco}">${this.bonusAttacco(attacco)}</label>
                  <label for="${attacco}">${this.bonusDanno(attacco)}</label>
                `).join('')}
              </div>
            </main>
          </details>

          <details open>
            <summary>Equipaggiamento — ${this.trasporto()}kg</summary>
            <main>
              <form style="display:grid; grid-template-columns: auto 40px 1fr; align-items: center; gap: 5px"
                    onsubmit="app.addToList('equipaggiamento', this, event)">
                <button type="submit" class="add"><span class="material-symbols-outlined">add</span></button>
                <input type="number" placeholder="Quantità">
                <div style="position: relative; display: inline-block;">
                  <input type="search" placeholder="Aggiungi equipaggiamento" id="add_equip" name="equipaggiamento.add">
                  <ul autocomplete="equipaggiamento.add">
                    ${(DND.oggetti || []).map(o=>`
                      <li>${o.key.charAt(0).toUpperCase()+o.key.slice(1)}</li>
                    `).join('')}
                  </ul>
                </div>
              </form>
              <div style="display:grid; grid-template-columns: auto 40px 1fr auto; align-items: center; gap: 5px">
              ${c.equipaggiamento.map((e, i) => `
                <button class="delete" onclick="app.deleteFromList('equipaggiamento', ${i})"><span class="material-symbols-outlined">close</span></button>
                <input value="${e.qta || 1}" onchange="app.handleChange(event)" name="equipaggiamento.${i}.qta" id="equipaggiamento.${i}.qta" type="number">
                <div style="position: relative; display: inline-block;"> 
                  <input value="${e.value || ''}" onchange="app.handleChange(event)" name="equipaggiamento.${i}.value" id="equipaggiamento.${i}.value" type="search" placeholder="Nome oggetto">
                  <ul autocomplete="equipaggiamento.${i}.value">
                    ${(DND.oggetti || []).map(o=>`
                      <li>${o.key.charAt(0).toUpperCase()+o.key.slice(1)}</li>
                    `).join('')}
                  </ul>
                </div>
                <label for="${e.value}">${(Number(e.qta)||1) * DND.peso(e.value)}kg</label>
              `).join('')}
              </div>
            </main>
          </details>
        </section>

        <!--DESTRA-->
        <section>
          <details open>
            <summary>Personalità</summary>
            <main>
            ${c.personalita.map((p, i)=>`
              <div class="score">
                <label for="${p.key}">${p.key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label>
                <textarea onchange="app.handleChange(event)" name="personalita.${i}.value" id="${p.key}">${p.value}</textarea>
              </div>
            `).join('')}
            </main>
          </details>

          <details open class="privilegi">
            <summary>Tratti e Privilegi</summary>
            <main>
              <div>
                ${this.privilegiMappati().filter(it => it.level === 0).map(({name, privileges})=>`
                  <div>
                    <section style="display: grid; grid-template-columns: 1fr; gap: 5px; padding: 5px 0;">
                      <div class="input">${name}</div>
                    </section>
                    <section>
                      <ul style="margin: 0 0 10px 25px; display: grid; gap: 8px;">
                        ${Array.isArray(privileges) ? privileges.map((p) => `
                          <li style="list-style: disc;">
                            <div><b>${p.privilege}</b>${p.description ? `: ${p.description}` : ''}</div>
                          </li>
                        `).join('') : ''}
                      </ul>
                    </section>
                  </div>
                `).join('')}
              </div>

              <form onsubmit="app.addToList('privilegi', this)" class="row">
                <button type="submit" class="add" aria-label="Aggiungi classe"><span class="material-symbols-outlined">add</span></button>
                <input name="privilegi" id="privilegi"
                    type="search" placeholder="Aggiungi classe" class="add">
                <ul autocomplete="privilegi" required>
                  ${DND.getSottoclasse(true).map(classe=>`
                    <li>${classe.charAt(0).toUpperCase()+classe.slice(1)}</li>
                  `).join('')}
                </ul>
              </form>

              <div>
              ${this.privilegiMappati().filter(it => it.level > 0).map(({name, privileges, level, srcIndex})=>`
                <div>
                  <section style="display: grid; grid-template-columns: auto 1fr; gap: 5px; padding: 5px 0;">
                    <button class="delete" onclick="app.deleteFromList('privilegi', ${srcIndex})"><span class="material-symbols-outlined">close</span></button>
                    <div style="position: relative; display: inline-block;">
                      <input value="${name}" onchange="app.handleChange(event)"
                             type="search" id="privilegi.${srcIndex}" name="privilegi.${srcIndex}">
                      <ul autocomplete="privilegi.${srcIndex}">
                        ${DND.getSottoclasse(true).map(classe=>`
                          <li>${classe.charAt(0).toUpperCase()+classe.slice(1)}</li>
                        `).join('')}
                      </ul>
                    </div>
                  </section>
                  <section>
                    <ul style="margin: 0 0 10px 25px; display: grid; gap: 8px;">
                      ${Array.isArray(privileges) ? privileges.map((p) => `
                        <li style="list-style: disc;">
                          <div><b>${p.privilege}</b>${p.description ? `: ${p.description}` : ''}</div>
                        </li>
                      `).join('') : ''}
                    </ul>
                  </section>
                </div>
                `).join('')}
               </div>
            </main>
          </details>
        </section>
      </article>
      <div id="toast" class="toast hide" role="status" aria-live="polite">Modificato</div>
    `;
    // Dopo il render, applica lo stato dei <details> e i listener
    this.applyDetails();
  }

}
new App();
</script>
</html>
